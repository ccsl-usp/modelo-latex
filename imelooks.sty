% 2017/01/01 -> fontenc TU and mandatory e-TeX support
\NeedsTeXFormat{LaTeX2e}[2017/01/01]
\ProvidesPackage{imelooks}[2023/05/03 1.0 IME/USP-style theses, articles etc.]

\RequirePackage{imegoodies}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% CORES (LINKS, PÔSTERES, APRESENTAÇÕES) %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Generic colors
\definecolor{Blackish}{HTML}{232830}
\definecolor{SandyPaper}{HTML}{FFFCE2}
\definecolor{BrownishGreen}{HTML}{5F603A}

% Greeny colors (based on the InterSCity project main color)
\definecolor{InterSCity}{HTML}{00998C}
\definecolor{DarkInterSCity}{HTML}{0D6D65}
\definecolor{PastelGreen}{HTML}{73937E}

% Colors defined in the IME-USP visual identity manual
\definecolor{imeblue}{RGB}{20,45,105}
\definecolor{imeyellow}{RGB}{230,175,60}
\definecolor{imered}{RGB}{130,20,60}
\definecolor{imesoftblue}{RGB}{0,100,160}

\newtoggle{IMEbluey}
\newtoggle{IMEgreeny}
\newtoggle{IMEsandy}

\newtoggle{IMEslides}
\newtoggle{IMEbeamer} % Não carrega pacotes incompatíveis com beamer
\newtoggle{IMEreport}
\newtoggle{IMEthesis}
\newtoggle{IMEposter}
\newtoggle{IMEresumoabstract}

\newtoggle{IMEbrazilian}
\newtoggle{IMEfonts}
\newtoggle{IMEbiblatex}
\newtoggle{IMEraggedbib}
\newtoggle{IMEmanualRaggedbib}
\newtoggle{IMEspacing}
\newtoggle{IMEcaptions}
\newtoggle{IMEfootnotes}
\newtoggle{IMEautohttp}
\newtoggle{IMEhidelinks}
\newtoggle{IMEcolorlinks}
\newtoggle{IMEborderlinks}
\newtoggle{IMElistings}
\newtoggle{IMEpseudocode}

\RequirePackage{l3keys2e}
\ExplSyntaxOn

\keys_define:nn {IME/looks}{
  presentation .code:n = {
    \toggletrue{IMEslides}
    \toggletrue{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \togglefalse{IMEposter}
    \togglefalse{IMEresumoabstract}
  },
  presentation .value_forbidden:n = true,
  slides .code:n = {
    \toggletrue{IMEslides}
    \toggletrue{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \togglefalse{IMEposter}
    \togglefalse{IMEresumoabstract}
  },
  slides .value_forbidden:n = true,
  poster .code:n = {
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \toggletrue{IMEposter}
    \togglefalse{IMEresumoabstract}
  },
  poster .value_forbidden:n = true,
  report .code:n = {
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \toggletrue{IMEreport}
    \togglefalse{IMEposter}
    \toggletrue{IMEresumoabstract}
  },
  report .value_forbidden:n = true,
  thesis .code:n = {
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \toggletrue{IMEreport}
    \toggletrue{IMEthesis}
    \togglefalse{IMEposter}
    \toggletrue{IMEbrazilian}
    \toggletrue{IMEresumoabstract}
  },
  thesis .value_forbidden:n = true,
  % beamer e resumoabstract devem vir depois de slides, report, thesis etc
  % porque as opções são processadas na ordem em que foram definidas aqui
  % (e não na ordem em que as opções são passadas para a classe). As
  % opções acima modificam os valores de IMEbeamer e IMEresumoabstract,
  % então estas opções devem estar aqui para poderem se sobrepor a isso.
  beamer .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEbeamer}}
              {\togglefalse{IMEbeamer}}
      },
  beamer .default:n = {true},
  nobeamer .code:n = {\togglefalse{IMEbeamer}},
  nobeamer .value_forbidden:n = true,
  resumoabstract .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEresumoabstract}}
              {\togglefalse{IMEresumoabstract}}
      },
  resumoabstract .default:n = {true},
  noresumoabstract .code:n = {\togglefalse{IMEresumoabstract}},
  noresumoabstract .value_forbidden:n = true,
  brazilian .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEbrazilian}}
              {\togglefalse{IMEbrazilian}}
      },
  brazilian .default:n = {true},
  nobrazilian .code:n = {\togglefalse{IMEbrazilian}},
  nobrazilian .value_forbidden:n = true,
  fonts .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEfonts}}
              {\togglefalse{IMEfonts}}
      },
  fonts .default:n = {true},
  nofonts .code:n = {\togglefalse{IMEfonts}},
  nofonts .value_forbidden:n = true,
  biblatex .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEbiblatex}}
              {\togglefalse{IMEbiblatex}}
      },
  biblatex .default:n = {true},
  nobiblatex .code:n = {\togglefalse{IMEbiblatex}},
  nobiblatex .value_forbidden:n = true,
  raggedbib .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \toggletrue{IMEmanualRaggedbib}
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEraggedbib}}
              {\togglefalse{IMEraggedbib}}
      },
  raggedbib .default:n = {true},
  noraggedbib .code:n = {
                            \toggletrue{IMEmanualRaggedbib}
                            \togglefalse{IMEraggedbib}
                        },
  noraggedbib .value_forbidden:n = true,
  bibstyle .tl_gset:N = \@IMEbibStyle,
  spacing .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEspacing}}
              {\togglefalse{IMEspacing}}
      },
  spacing .default:n = {true},
  nospacing .code:n = {\togglefalse{IMEspacing}},
  nospacing .value_forbidden:n = true,
  captions .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEcaptions}}
              {\togglefalse{IMEcaptions}}
      },
  captions .default:n = {true},
  nocaptions .code:n = {\togglefalse{IMEcaptions}},
  nocaptions .value_forbidden:n = true,
  footnotes .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEfootnotes}}
              {\togglefalse{IMEfootnotes}}
      },
  footnotes .default:n = {true},
  nofootnotes .code:n = {\togglefalse{IMEfootnotes}},
  nofootnotes .value_forbidden:n = true,
  autohttp .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEautohttp}}
              {\togglefalse{IMEautohttp}}
      },
  autohttp .default:n = {true},
  noautohttp .code:n = {\togglefalse{IMEautohttp}},
  noautohttp .value_forbidden:n = true,
  colorlinks .code:n = {
    \togglefalse{IMEhidelinks}
    \toggletrue{IMEcolorlinks}
    \togglefalse{IMEborderlinks}
  },
  colorlinks .value_forbidden:n = true,
  borderlinks .code:n = {
    \togglefalse{IMEhidelinks}
    \togglefalse{IMEcolorlinks}
    \toggletrue{IMEborderlinks}
  },
  borderlinks .value_forbidden:n = true,
  hidelinks .code:n = {
    \toggletrue{IMEhidelinks}
    \togglefalse{IMEcolorlinks}
    \togglefalse{IMEborderlinks}
  },
  hidelinks .value_forbidden:n = true,
  greeny .code:n = {
      \colorlet{IMEframe}{DarkInterSCity}
      \colorlet{IMEbg}{SandyPaper}
      \colorlet{IMElabel}{DarkInterSCity}
      \colorlet{IMEtitleBorder}{imeyellow}
      \colorlet{IMEtitlebg}{DarkInterSCity}
      \colorlet{IMEfooterbg}{DarkInterSCity}
      \toggletrue{IMEgreeny}
      \togglefalse{IMEbluey}
      \togglefalse{IMEsandy}
  },
  greeny .value_forbidden:n = true,
  bluey .code:n = {
      \colorlet{IMEframe}{imesoftblue}
      \colorlet{IMEbg}{SandyPaper}
      \colorlet{IMElabel}{imeblue}
      \colorlet{IMEtitleBorder}{imeyellow}
      \colorlet{IMEtitlebg}{imeblue}
      \colorlet{IMEfooterbg}{imesoftblue}
      \togglefalse{IMEgreeny}
      \toggletrue{IMEbluey}
      \togglefalse{IMEsandy}
  },
  bluey .value_forbidden:n = true,
  sandy .code:n = {
      \colorlet{IMEframe}{BrownishGreen!60!white}
      \colorlet{IMEbg}{SandyPaper}
      \colorlet{IMElabel}{BrownishGreen}
      \colorlet{IMEtitleBorder}{imeyellow}
      \colorlet{IMEtitlebg}{BrownishGreen}
      \colorlet{IMEfooterbg}{BrownishGreen}
      \togglefalse{IMEgreeny}
      \togglefalse{IMEbluey}
      \toggletrue{IMEsandy}
  },
  sandy .value_forbidden:n = true,
  listings .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMElistings}}
              {\togglefalse{IMElistings}}
      },
  listings .default:n = {true},
  nolistings .code:n = {\togglefalse{IMElistings}},
  nolistings .value_forbidden:n = true,
  pseudocode .choices:nn =
      {true, True, yes, Yes, y, Y, t, T, false, False, no, No, n, N, f, F}
      {
          \int_compare:nNnTF{\l_keys_choice_int}<{9}
              {\toggletrue{IMEpseudocode}}
              {\togglefalse{IMEpseudocode}}
      },
  pseudocode .default:n = {true},
  nopseudocode .value_forbidden:n = true,
  nopseudocode .code:n = {\togglefalse{IMEpseudocode}},
}

% Defaults
\keys_set:nn{IME/looks}{
    fonts,
    biblatex,
    spacing,
    colorlinks,
    captions,
    footnotes,
    autohttp,
    bluey,
    listings,
    pseudocode,
}

\ProcessKeysOptions{IME/looks}

\iftoggle{IMEautohttp}{\LetLtxMacro\url\httpurl}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LÍNGUAS (BRAZILIAN) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
\newtoggle{IMEfound}
\NewDocumentCommand\IMEcheckLangLoaded{m m m}{
  \togglefalse{IMEfound}
  \seq_gclear_new:N \l_tmpa_seq
  \seq_gset_from_clist:Nc \l_tmpa_seq {@classoptionslist}

  \seq_map_inline:Nn \l_tmpa_seq{
      \ifstrequal{#1}{##1}
        {\toggletrue{IMEfound}}
        {}
  }

  \ifdefvoid{\bbl@loaded}
    {}
    {
      \seq_gclear_new:N \l_tmpa_seq
      \seq_gset_from_clist:Nc \l_tmpa_seq {bbl@loaded}

      \seq_map_inline:Nn \l_tmpa_seq{
          \ifstrequal{#1}{##1}
            {\toggletrue{IMEfound}}
            {}
      }
    }

  \iftoggle{IMEfound}{#2}{#3}
}
\ExplSyntaxOff

\IMEcheckLangLoaded{brazilian}
  {
    % Por padrão, LaTeX utiliza maiúsculas no início de cada palavra
    % nestas expressões ("Lista de Figuras"); vamos usar maiúsculas
    % apenas na primeira palavra.
    \addto\captionsbrazilian{%
      \renewcommand\listfigurename{Lista de figuras}%
      \renewcommand\listtablename{Lista de tabelas}%
      \renewcommand\indexname{Índice remissivo}%
    }
  }
  {
    \iftoggle{IMEbrazilian}{
        \PackageError{imelooks}{Language "brazilian" not loaded}
        {IME theses expect "brazilian" to be set as a language\MessageBreak
        in the class options list (in general, "brazilian" and\MessageBreak
        "portuguese" are preferred over "brazil" and "portuges").\MessageBreak
        If you really do not want it, add option "nobrazilian" to\MessageBreak
        this package options, but that is not guaranteed to work.}
    }{}
  }

% TODO: Com versões recentes de hyperxmp (final de 2020), não é necessário
%       definir pdflang (hyperxmp usa babel para identificar a língua), mas
%       isso não causa problemas. Vamos remover isto quando ubuntu 20.04
%       (focal) for descontinuada (abril/2025) e arxiv usar TeXLive >= 2021.
\AtEndPreamble{
  \IfLanguagePatterns{brazilian}
    {\hypersetup{pdflang={pt}, pdfmetalang={pt}}}
    {}
  \IfLanguagePatterns{english}
    {\hypersetup{pdflang={en}, pdfmetalang={en}}}
    {}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FONTES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Se você está lendo isto, é porque gostaria de modificar os tipos de
% letra do seu documento. A maneira mais simples de fazer isso é consultar
% o sítio https://tug.org/FontCatalogue/ e utilizar as packages indicadas.
% Se o sítio informa que a fonte está disponível *apenas* em formato OTF,
% use lualatex; se *não* está disponível em formato OTF, use pdflatex
% (lualatex também funciona, mas o resultado será inferior). Se está
% disponível em formato OTF e também algum outro, você pode usar qualquer
% um dos dois. Para usar alguma outra fonte instalada em seu computador
% que não foi adaptada especificamente para LaTeX, use lualatex e leia
% a documentação da package fontspec. O que segue são mais detalhes que
% você provavelmente não precisa ler.

% Você normalmente não precisa lidar com isso, mas pode ser útil saber:
% O mecanismo usado por LaTeX para gerir fontes é o NFSS (veja "texdoc
% fntguide"). NFSS funciona com todas as versões de LaTeX, mas só com fontes
% que foram adaptadas para funcionar com ele. LuaLaTeX e XeLaTeX estendem o
% NFSS: através da package fontspec, eles podem utilizar quaisquer fontes
% instaladas no computador e acessar diversos recursos tipográficos com mais
% facilidade. De maneira geral, se quiser fazer algo especial com as fontes
% do seu documento, atualmente não é mais necessário entender o NFSS; basta
% usar lualatex e seguir a documentação da package fontspec.

% É possível usar várias famílias tipográficas diferentes em um único
% documento LaTeX, mas isso não é trivial. Algumas (poucas) packages
% fornecem comandos prontos para ativar uma família tipográfica a partir
% de seu nome, como "\carlito", mas esse tipo de recurso raramente é
% utilizado. Ao invés disso, LaTeX considera que, em geral, um documento
% precisa de apenas três estilos de letras genéricos, acionados pelos
% comandos abaixo:
%
% * \rmfamily e \textrm -> letras serifadas, para o corpo do texto. É o
%   padrão inicial do documento;
%
% * \sffamily e \textsf -> letras sem serifa, para títulos ou "entidades".
%   Por exemplo, "a classe \textsf{TimeManager} é responsável..." ou
%   "chamamos \textsf{primos} os números que...". Observe que em quase
%   todos os casos desse tipo é mais adequado usar negrito ou itálico;
%
% * \ttfamily e \texttt -> letras "teletype", para trechos de programas.
%
% LaTeX também carrega uma fonte específica, visualmente similar à fonte
% serifada, ao ativar o modo matemático.
%
% Por padrão, esses comandos selecionam fontes da família "Computer Modern",
% mas diversas packages os redefinem para carregar outras. Algumas dessas
% packages alteram apenas uma das quatro fontes, enquanto outras alteram
% todas de uma vez de maneira que o conjunto seja coerente.

% Como dito acima, é possível mudar apenas uma das fontes. Em particular,
% a fonte teletype da família Computer Modern foi criada para simular as
% impressoras dos anos 1970/1980. Sendo assim, ela é uma fonte (1) com
% serifas e (2) de espaçamento fixo. Hoje em dia, é mais comum usar fontes
% sem serifa para representar código-fonte. Além disso, ao imprimir, é
% comum adotar fontes que não são de espaçamento fixo para fazer caber
% mais caracteres em uma linha de texto. Algumas opções de fontes para
% esse fim:
%\usepackage{newtxtt} % Não funciona com fontspec (lualatex / xelatex)
%\usepackage{DejaVuSansMono}
% inconsolata é uma boa fonte, mas não tem variante itálico
%\ifPDFTeX
%  \usepackage[narrow]{inconsolata}
%\else
%  \setmonofont{inconsolatan}
%\fi
%
% Também é possível usar Times como padrão; nesse caso, a fonte sem
% serifa usualmente é Helvetica e a fonte teletype em geral é Courier:
%\ifPDFTeX
%  \usepackage[helvratio=0.95,largesc]{newtxtext}
%  \usepackage{newtxtt} % Fonte teletype
%  \usepackage{newtxmath}
%\else
%  % Clone da fonte Times como fonte principal
%  \setmainfont{TeX Gyre Termes}
%  \setmathfont[Scale=MatchLowercase]{TeX Gyre Termes Math}
%  % TeX Gyre Termes Math tem um bug e não define o caracter
%  % \setminus; Vamos contornar esse problema usando apenas
%  % esse caracter da fonte STIX Two Math
%  \setmathfont[range=\setminus]{STIX Two Math}
%  % Clone da fonte Helvetica como fonte sem serifa
%  \setsansfont{TeX Gyre Heros}
%  % Clone da Courier como fonte teletype
%  %\setmonofont{TeX Gyre Cursor}
%\fi

\iftoggle{IMEfonts}{

  % Uma boa fonte teletype
  \RequirePackage[scale=.85]{sourcecodepro}

  % Uma ótima opção de família para o corpo do texto é a libertinus,
  % similar (mas não igual) à Times, mas com suporte a Small Caps e
  % outras qualidades. A fonte teletype da família é serifada, então
  % é melhor definir outra; a opção "mono=false" faz o pacote não
  % carregá-la, mantendo a escolha anterior.
  \RequirePackage[mono=false]{libertinus}

  \ifPDFTeX
    % A família libertinus por padrão não define uma fonte matemática
    % específica para pdfLaTeX; uma opção que funciona bem com ela:
    %\RequirePackage[libertine]{newtxmath}
    % Outra, provavelmente melhor:
    \RequirePackage{libertinust1math}
  \fi

  % Com LuaLaTeX/XeLaTeX, Libertinus configura também
  % a fonte matemática; aqui só precisamos corrigir \mathit
  \ifLuaTeX
    \setmathfontface\mathit{Libertinus Serif Italic}
  \fi
  \ifXeTeX
    % O nome de arquivo da fonte mudou na versão 2019-04-04
    \@ifpackagelater{libertinus-otf}{2019/04/03}
        {\setmathfontface\mathit{LibertinusSerif-Italic.otf}}
        {\setmathfontface\mathit{libertinusserif-italic.otf}}
  \fi

  % Vamos lembrar destas configurações
  \let\LibertinusSerifFont\rmdefault
  \let\LibertinusSansFont\sfdefault
  \let\SourceCodeProFont\ttdefault
  \let\LibertinusMDDefault\mddefault
  \let\LibertinusBFDefault\bfdefault
  \let\LibertinusUPdefault\updefault
  \let\LibertinusITdefault\itdefault
  \let\LibertinusSCdefault\scdefault
  \let\LibertinusFamily\familydefault
  \let\LibertinusSeries\seriesdefault
  \let\LibertinusShape\shapedefault
  \let\LibertinusMDrm\mdseries@rm
  \let\LibertinusMDsf\mdseries@sf
  \let\LibertinusMDtt\mdseries@tt
  \let\LibertinusBFrm\bfseries@rm
  \let\LibertinusBFsf\bfseries@sf
  \let\LibertinusBFtt\bfseries@tt

  % Este comando é definido pela package url, que é carregada automaticamente
  % por hyperref; ele faz URLs com fonte sem serifa ao invés de teletype
  \urlstyle{sf}

  % Melhorias e personalização do sublinhado com soul (comando \ul)

  \setul{1.4pt}{.5pt} % Distância e largura do sublinhado

  % TODO: talvez usar "em" ao invés de pt?
  % btul -> "Better Underline" (https://alexwlchan.net/2017/10/latex-underlines/ )
  % Sublinhado sem cruzar as linhas descendentes dos caracteres
  \RequirePackage[outline]{contour}
  \contourlength{1.1pt}
  \newcommand{\btul}[2][white]{%
    \contourlength{1.1pt}%
    \setul{1.4pt}{.5pt}%
    \ul{{\phantom{#2}}}% Faz o sublinhado; precisa das chaves adicionais!
    \llap{\contour{#1}{#2}}% Escreve o texto com fundo branco/colorido
  }

}{} % \iftoggle{IMEfonts}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ESTRUTURA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Packages úteis que são incompatíveis com beamer
\iftoggle{IMEbeamer}
  {}
  {
    % Ao criar uma referência hyperref para um float, a referência
    % aponta para o final do caption do float, o que não é muito bom.
    % Este pacote faz a referência apontar para o início do float (é
    % possível personalizar também).
    \RequirePackage[all]{hypcap}

    % Formatação personalizada das listas "itemize", "enumerate" e
    % "description", além de permitir criar novos tipos de listas. Com
    % a opção "inline", a package define os novos ambientes "itemize*",
    % "description*" e "enumerate*", que fazem os itens da lista como
    % parte de um único parágrafo.
    \RequirePackage[inline]{enumitem}

    % titlesec permite definir formatação personalizada de títulos,
    % seções etc. Observe que titlesec é incompatível com os comandos
    % refsection e refsegment do pacote biblatex! Aqui, carregamos a
    % package apenas para fazer os títulos alinhados à esquerda.
    \RequirePackage[raggedright]{titlesec}
  }

% Só numera até o nível 2 (subseções, como 2.3.1), ou seja, não numera
% sub-subseções (como 2.3.1.1). Veja que isso afeta referências
% cruzadas: se você fizer \ref{uma-sub-subsecao} sem que ela seja
% numerada, a referência vai apontar para a seção um nível acima.
% Veja também tocdepth abaixo.
\setcounter{secnumdepth}{2}

\iftoggle{IMEreport}{
  % Formatação personalizada do sumário, lista de tabelas/figuras etc.
  % Não utilizado neste modelo.
  %\RequirePackage{titletoc}

  % biblatex pode ser configurado para inserir a bibliografia no sumário;
  % bibtex não oferece essa possibilidade. Com esta package, resolvemos
  % esse problema.
  \RequirePackage[nottoc,notlot,notlof]{tocbibind}

  % Só olha até o nível 2 (subseções) para gerar o sumário e os
  % cabeçalhos, ou seja, não coloca nomes de subsubseções (nível 3)
  % no sumário nem nos cabeçalhos. Veja também secnumdepth acima.
  \setcounter{tocdepth}{2}

  % Normalmente, o capítulo de introdução não deve ser numerado, mas
  % deve aparecer no sumário. Por padrão, LaTeX não oferece uma solução
  % para isso, então modificamos aqui os comandos \chapter, \section,
  % \subsection e \subsubsection (embora este último provavelmente nunca
  % será útil) para que, ao serem chamados com dois asteriscos, eles
  % implementem esse comportamento.

  \let\IMEorigchapter\chapter
  \let\IMEorigsection\section
  \let\IMEorigsubsection\subsection
  \let\IMEorigsubsubsection\subsubsection

  \renewcommand\chapter{%
    \@ifstar
      {\@ifstar{\unnumberedchapter}{\IMEorigchapter*}}
      {\IMEorigchapter}%
  }

  \renewcommand\section{%
    \@ifstar
      {\@ifstar{\unnumberedsection}{\IMEorigsection*}}
      {\IMEorigsection}%
  }

  \renewcommand\subsection{%
    \@ifstar
      {\@ifstar{\unnumberedsubsection}{\IMEorigsubsection*}}
      {\IMEorigsubsection}%
  }

  \renewcommand\subsubsection{%
    \@ifstar
      {\@ifstar{\unnumberedsubsubsection}{\IMEorigsubsubsection*}}
      {\IMEorigsubsubsection}%
  }

  \newcommand\unnumberedchapter[2][]{
    \IMEorigchapter*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{chapter}{#2}\chaptermark{#2}}
      {\addcontentsline{toc}{chapter}{#1}\chaptermark{#1}}
  }

  \newcommand{\unnumberedsection}[2][]{
    \IMEorigsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{section}{#2}\sectionmark{#2}}
      {\addcontentsline{toc}{section}{#1}\sectionmark{#1}}
  }

  \newcommand{\unnumberedsubsection}[2][]{
    \IMEorigsubsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{subsection}{#2}}
      {\addcontentsline{toc}{subsection}{#1}}
  }

  \newcommand{\unnumberedsubsubsection}[2][]{
    \IMEorigsubsubsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{subsubsection}{#2}}
      {\addcontentsline{toc}{subsubsection}{#1}}
  }

}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% CORES E APARÊNCIA DOS LINKS %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%% LINKS
\iftoggle{IMEhidelinks}
  {\hypersetup{hidelinks}}
  {}

\iftoggle{IMEcolorlinks}{
    \hypersetup{
      colorlinks=true, % também desabilita pdfborderstyle
      %citecolor=black,
      %linkcolor=black,
      %urlcolor=black,
      %filecolor=black,
      citecolor=DarkGreen,
      linkcolor=NavyBlue,
      urlcolor=DarkRed,
      filecolor=green,
      anchorcolor=black,
    }
}{}

\iftoggle{IMEborderlinks}{
    \hypersetup{
      colorlinks=false,
      pdfborder={0 0 .6},
      pdfborderstyle={/S/U/W .6},
      urlbordercolor=DodgerBlue,
      citebordercolor=green!30!white,
      linkbordercolor=blue!30!white,
      filebordercolor=green!30!white,
    }
}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BIBLIOGRAFIA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Tradicionalmente, bibliografias no LaTeX são geradas com uma combinação entre
% LaTeX (muitas vezes usando o pacote natbib) e um programa auxiliar chamado
% bibtex. Nesse esquema, LaTeX e natbib são responsáveis por formatar as
% referências ao longo do texto e a formatação da bibliografia fica por conta
% do programa bibtex. A configuração dessa formatação é feita através de um
% arquivo auxiliar de "estilo", com extensão ".bst". Vários journals etc.
% fornecem o arquivo .bst que corresponde ao formato esperado da bibliografia.
%
% bibtex e natbib funcionam bem e, se você tiver alguma boa razão para usá-los,
% obterá bons resultados. No entanto, bibtex tem dois problemas: não lida
% corretamente com caracteres acentuados (embora, na prática, funcione com
% os caracteres usados em português) e o formato .bst, que define a formatação
% da bibliografia, é complexo e pouco flexível.
%
% Por conta disso, a comunidade está migrando para um novo sistema chamado
% biblatex. No biblatex, as formatações da bibliografia e das citações são
% feitas pelo próprio pacote biblatex, dentro do LaTeX. Assim, é bem mais fácil
% modificar e personalizar o estilo da bibliografia. biblatex usa o mesmo
% formato de arquivo de dados do bibtex (".bib") e, portanto, não é difícil
% migrar de um para o outro. biblatex também usa um programa auxiliar (biber),
% mas não para realizar a formatação da bibliografia. A maior desvantagem de
% biblatex é que ele é significativamente mais lento que bibtex.
%
% Observe que biblatex pode criar bibliografias independentes por capítulo
% ou outras divisões do texto. Normalmente é preciso indicar essas seções
% manualmente, mas as opções "refsection" e "refsegment" fazem biblatex
% identificar cada capítulo/seção/etc como uma nova divisão desse tipo. No
% entanto, refsection e refsegment são incompatíveis com o pacote titlesec.
% Se você pretende criar bibliografias independentes por seções, há duas
% soluções: (1) desabilitar o pacote titlesec; (2) indicar as seções
% manualmente.
%
% Algumas dicas de configuração:
% https://tex.stackexchange.com/q/12806
% https://github.com/PaulStanley/biblatex-tutorial/releases

%%%%%%%%%%%%%%%%%%%
%%%% ATENÇÃO!! %%%%
%%%%%%%%%%%%%%%%%%%
%
% Com beamer, apenas estilos bibliográficos derivados de authortitle,
% numeric, alphabetic ou authoryear (como beamer-ime) vão funcionar
% corretamente! Outros estilos, como abnt ou apa, vão gerar problemas
% de layout que você vai precisar ajustar manualmente. Observe que,
% num poster ou apresentação, provavelmente é uma boa ideia usar
% apenas \nocite e não \cite.

\ifboolexpr
  {
    not test {\ifdefvoid{\@IMEbibStyle}}
    and not togl {IMEbiblatex}
  }
  {
    \ClassWarningNoLine{imelooks}
      {%
        ****************************************************\MessageBreak
        bibstyle makes no sense with nousebiblatex; ignoring\MessageBreak
        ****************************************************
      }
  }
  {}

\iftoggle{IMEbiblatex}{
  \ifdefvoid{\@IMEbibStyle}
    {
      \iftoggle{IMEreport}{
        \gdef\@IMEbibStyle{plainnat-ime}
      }{
        \ifboolexpr{togl {IMEslides} or togl {IMEposter}}
          {\gdef\@IMEbibStyle{beamer-ime}}
          {\gdef\@IMEbibStyle{numeric}} % article
      }
    }
    {}

  \iftoggle{IMEmanualRaggedbib}
    {}
    {
        \ifdefstring{\@IMEbibStyle}{plainnat-ime}
            {}
            {\toggletrue{IMEraggedbib}}
    }

  % Inclui, em cada item da bibliografia, links
  % para as páginas onde o item foi citado
  \iftoggle{IMEreport}{\PassOptionsToPackage{backref=true}{biblatex}}{}

  % raggedright + incentivo a quebras de linha entre blocos
  \iftoggle{IMEraggedbib}{\PassOptionsToPackage{block=ragged}{biblatex}}{}

  \RequirePackage[
    style=\@IMEbibStyle,
    natbib=true, % Reconhece a sintaxe de natbib (\citet, \citep)
    hyperref=true, % Ativa o suporte ao pacote hyperref
    % Se um item da bibliografia tem língua definida (com langid), permite
    % hifenizar com base na língua selecionada.
    autolang=hyphen,
  ]{biblatex}

  % TODO: remover menção ao bug de atendvi/hyperxmp em 2024
  % Impede que um item da bibliografia seja dividido em duas páginas.
  % À parte a estética, isso contorna este bug, que afeta links na
  % úlima página do trabalho, ou seja, pode afetar a bibliografia
  % (atenddvi pode ser carregada por hyperxmp):
  % https://github.com/ho-tex/atenddvi/issues/1
  \AtBeginBibliography{\interlinepenalty=10000\raggedbottom}

  \iftoggle{IMEraggedbib}{
    % Vamos fazer a bibliografia raggedright (veja também "block=ragged" mais
    % acima) e permitir um pouco mais de "raggedness" para minimizar hífens.
    \AtBeginBibliography{
      \evenRaggedRight
      \hyphenpenalty=400 % Default 50
    }
  }
  {}

  % Numa apresentação/poster, a bibliografia pode usar fonte menor
  \iftoggle{IMEslides}
    {
        \renewcommand*\bibfont{\footnotesize}
        % O tema metropolis redefine o tamanho das fontes na bibliografia;
        % antes de TeXLive 2023, o código de beamer tinha um bug que fazia
        % isso não ter efeito, mas esse bug foi corrigido, então aqui
        % desfazemos a alteração do tema metropolis.
        \AtEndOfPackageFile*{beamerthememetropolis}{
            \setbeamerfont*{bibliography entry author}{}
            \setbeamerfont*{bibliography entry title}{}
            \setbeamerfont*{bibliography entry location}{}
            \setbeamerfont*{bibliography entry note}{}
        }
    }
    {}

  \iftoggle{IMEposter}
    {\renewcommand*\bibfont{\scriptsize}}
    {}

  \iftoggle{IMEposter}{
    \DeclarePrintbibliographyDefaults{heading=none}

    \defbibenvironment{bibliography}
      {%
        \list
          {%
            \color{imeblue}\raisebox{.1em}{%
            \@IMEcharscale{.26}{\ensuremath{\blacktriangleright}}}%
          }
          {%
            \setlength{\leftmargin}{\bibhang}%
            \setlength{\itemindent}{0pt}%
            \setlength{\itemsep}{\bibitemsep}%
            \setlength{\parsep}{\bibparsep}%
          }%
      }
      {\endlist}
      {\item}
  }{}

}{} % \iftoggle{IMEbiblatex}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DIVERSOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%% FOOTNOTES
\iftoggle{IMEfootnotes}{
  % Formatação personalizada das notas de threeparttable:
  \appto{\TPTnoteSettings}{\footnotesize\itshape}
  \def\TPTtagStyle{\textit}

  % Formato personalizado para as notas de rodapé. Copiado quase
  % literalmente do exemplo na documentação das classes-padrão de
  % LaTeX2e (texdoc classes). Seria possível fazer algo similar
  % usando list{} com um único item usando \@thefnmark como label.

  % \footnotesep não é um espaço adicional, mas sim um strut que
  % existe no começo de cada nota. É por isso que o valor é "grande"
  % (\baselineskip) mas a separação de fato é pequena.

  \renewcommand\@makefntext[1]{%
      \setlength{\footnotesep}{1\baselineskip}%
      \@setpar{%
          \@@par
          \@tempdima = \hsize
          \advance\@tempdima-4pt\relax
          \parshape \@ne 4pt \@tempdima
      }%
      \par
      \parindent 1em\noindent
      \parskip .3\baselineskip
      \hbox to \z@{\hss\@makefnmark\,}#1%
  }

  % \maketitle redefine as notas de rodapé (\thanks) para usar símbolos
  % ao invés de números, mas essa não é a única mudança. A versão de
  % \maketitle da classe article também muda \@makefnmark para que a
  % indicação de nota de rodapé não ocupe espaço horizontal (usando
  % \rlap). Isso é feito porque a lista de autores em geral é similar a
  % \author{Fulano\thanks{instituição 1}, Ciclano\thanks{instituição 2}}.
  % Com essa mudança, a nota aparece acima da vírgula entre os autores.
  % Mas isso significa que \maketitle precisa também modificar \@makefntext
  % para que esse efeito aconteça apenas na lista de autores e não na
  % nota em si. Assim, como criamos um novo formato para as notas de
  % rodapé, precisamos mudar o formato em \maketitle também.

  \newcommand\@maketitlemakefntext[1]{%
      \setlength{\footnotesep}{1\baselineskip}%
      \@setpar{%
          \@@par
          \@tempdima = \hsize
          \advance\@tempdima-4pt\relax
          \parshape \@ne 4pt \@tempdima
      }%
      \par
      \parindent 1em\noindent
      \parskip .3\baselineskip
      \hbox to \z@{\hss\@textsuperscript{\normalfont\@thefnmark}\,}#1%
  }

  % Primeiro tentamos alterar a versão padrão de \maketitle, mas isso
  % provavelmente vai falhar porque carregamos a package hyperref.
  % Nesse caso, fazemos a alteração na versão modificada por ela. Se
  % não estamos usando a classe article, nenhuma das duas alterações
  % vai funcionar, mas isso não é um problema.
  \patchcmd\maketitle
    {\long\def\@makefntext}
    {\let\@makefntext\@maketitlemakefntext\long\def\@disabledmakefntext}
    {}
    {
      \patchcmd\HyOrg@maketitle
        {\long\def\@makefntext}
        {\let\@makefntext\@maketitlemakefntext\long\def\@disabledmakefntext}
        {}{}
    }
}{} % \iftoggle{IMEfootnotes}

%%%%%%%%% SPACING
\iftoggle{IMEspacing}{

  % LaTeX por default segue o estilo americano e não faz a indentação da
  % primeira linha do primeiro parágrafo de uma seção; este pacote ativa
  % essa indentação, como é o estilo brasileiro
  \RequirePackage{indentfirst}

  % Em documentos frente-e-verso, LaTeX faz o final da página terminar sempre
  % no mesmo lugar (exceto no final dos capítulos). Esse comportamento pode ser
  % ativado explicitamente com o comando "\flushbottom". Mas se, por alguma
  % razão, o volume de texto na página é "pequeno", essa página vai ter espaços
  % verticais artificialmente grandes. Uma solução para esse problema é utilizar
  % "\raggedbottom" (padrão em documentos que não são frente-e-verso): com essa
  % opção, as páginas podem terminar em alturas ligeiramente diferentes. Outra
  % opção é corrigir manualmente cada página problemática, por exemplo com o
  % comando "\enlargethispage".
  %\raggedbottom
  \flushbottom

  % Por padrão, LaTeX coloca uma espaço aumentado após sinais de pontuação;
  % Isso não é tão bom quanto alguns TeX-eiros defendem :) .
  % Esta opção desabilita isso e, consequentemente, evita problemas com
  % "id est" (i.e.) e "exempli gratia" (e.g.)
  \frenchspacing

  % A primeira linha de cada parágrafo costuma ter um pequeno recuo para
  % tornar mais fácil visualizar onde cada parágrafo começa. Além disso, é
  % possível colocar um espaço em branco entre um parágrafo e outro. Esta
  % package coloca o espaço em branco e desabilita o recuo; como queremos
  % o espaço *e* o recuo, é preciso guardar o valor padrão do recuo e
  % redefini-lo depois de carregar a package.
  % TODO: depois que ubuntu 18.04 se tornar obsoleta (abril/2023), remover
  %       as linhas "oldparindent" e carregar a package com a opção "indent".
  \ifboolexpr{togl {IMEslides} or togl {IMEposter}}
    {}
    {
      \newlength\oldparindent
      \setlength\oldparindent\parindent
      \RequirePackage[parfill]{parskip}
      \setlength\parindent\oldparindent

      % Workaround for https://github.com/FrankMittelbach/fmitex-parskip/issues/5
      \AtBeginDocument{
          \ifx\Hy@deferred@thm@head\@undefined\else
          \patchcmd\Hy@deferred@thm@head
              {\addvspace{-\parskip}}{}%
              {}{\typeout{Couldn't patch \string\deferred@thm@head!}}%
          \fi
      }

      % Prefer paragraph formatting in which the last line is not too short.
      % TODO: check the "appendix A" line break in the example text.
      \setlength\parfillskip{30pt plus .9\linewidth minus 30pt\relax}
    }


  \ifboolexpr{togl {IMEbeamer} or togl {IMEposter}}
    {}
    {
      % Ao invés de definir o tamanho das margens, vamos definir os tamanhos do
      % texto, do cabeçalho e do rodapé, e deixamos a package geometry calcular
      % o tamanho das margens em função do tamanho do papel. Assim, obtemos o
      % mesmo resultado impresso, mas com margens diferentes, se o tamanho do
      % papel for diferente.
      \geometry{
        textwidth=152mm,
        hmarginratio=12:17, % 24:34 -> com A4: 24mm + 152mm + 34mm = 210mm
        textheight=237mm,
        vmarginratio=8:7, % 32:28 -> com A4: 32mm + 237mm + 28mm = 297mm
        headsep=11mm, % distância entre a base do cabeçalho e o texto
        headheight=21mm, % qquer medida grande o suficiente, ex: top - headsep
        footskip=10mm,
        marginpar=20mm,
        marginparsep=5mm,
      }
    }

}{} % \iftoggle{IMEspacing}

%%%%%%%%%%%%% CAPTIONS
\iftoggle{IMEcaptions}{
  % Captions com fonte menor, indentação normal, corpo do texto
  % negrito e nome do caption itálico
  \RequirePackage[
    font=small,
    format=plain,
    labelfont={bf,up},
    textfont={normalfont,it}]{caption}

  % Em geral, a package caption é capaz de "adivinhar" se o caption
  % está acima ou abaixo da figura/tabela, mas isso não funciona
  % corretamente com longtable. Aqui, forçamos a package a considerar
  % que os captions ficam abaixo das tabelas.
  \captionsetup*[longtable]{position=bottom}
}{}

%%%%%%%%%% PGFGANTT (GANTT CHARTS)
% Estes parâmetros definem a aparência das gantt charts e variam
% em função da fonte do documento.
\ganttset{
    vgrid,
    x unit=1.7em,
    y unit title=3ex,
    y unit chart=4ex,
    % O "strut" é necessário para alinhar o baseline dos nomes dos meses
    title label font=\strut\footnotesize,
    group label font=\footnotesize\bfseries,
    bar label font=\footnotesize,
    milestone label font=\footnotesize\itshape,
    % "align=right" é necessário para \ganttalignnewline funcionar
    group label node/.append style={align=right},
    bar label node/.append style={align=right},
    milestone label node/.append style={align=right},
    group incomplete/.append style={fill=black!50},
    bar/.append style={fill=black!25,draw=black},
    bar incomplete/.append style={fill=white,draw=black},
    % Não é preciso imprimir "0%"
    progress label text=\ifnumequal{#1}{0}{}{(#1\%)},
    % Formato e tamanho dos elementos
    title height=.9,
    group top shift=.4,
    group left shift=0,
    group right shift=0,
    group peaks tip position=0,
    group peaks width=.2,
    group peaks height=.3,
    milestone height=.4,
    milestone top shift=.4,
    milestone left shift=.8,
    milestone right shift=.2,
}


\iftoggle{IMElistings}{

  % Para formatar código-fonte (ex. em Java). listings funciona bem mas
  % tem algumas limitações (https://tex.stackexchange.com/a/153915 ).
  % Se isso for um problema, a package minted pode oferecer resultados
  % (muito) melhores; a desvantagem é que ela depende de um programa
  % externo, o pygments (escrito em python).
  %
  % listings também não tem suporte específico a pseudo-código, mas
  % incluímos uma configuração para isso que deve ser suficiente.
  % Caso contrário, há diversas packages específicas para a criação
  % de pseudocódigo:
  %
  %  * a mais comum é algorithmicx ("\usepackage{algpseudocode}");
  %
  %  * algorithm2e é bastante flexível, mas um tanto complexa;
  %
  %  * clrscode3e foi usada no livro "Introduction to Algorithms",
  %    de Cormen, Leiserson, Rivert e Stein;
  %
  %  * pseudocode foi usada no livro "Combinatorial Algorithms",
  %    de Kreher e Stinson;
  %
  %  * algpseudocodex é uma package relativamente nova similar
  %    a algorithmicx/algpseudocode mas com diversas melhorias;
  %
  %  * pseudo também é relativamente nova; ela funciona de forma
  %    um pouco diferente das demais e é bastante customizável.
  %
  % A diferença entre essas packages e listings/minted é que estas
  % últimas "entendem" o código e aplicam a formatação automaticamente,
  % enquanto com as packages acima o usuário precisa usar comandos LaTeX
  % para definir a formatação.
  %
  % algorithmicx/algpseudocode, algorithm2e, clrscode3e, pseudocode
  % e algpseudocodex usam uma "linguagem" própria baseada em comandos
  % LaTeX que pode ser facilmente modificada pelo usuário (ou seja,
  % é fácil fazer pseudocódigo em português). Segue um exemplo com
  % algpseudocodex, provavelmente a opção mais interessante dentre
  % este grupo (note o comando "\While", que imprime automaticamente
  % a palavra-chave "while" e ajusta a indentação):
  %
  % \begin{algorithmic}[1]
  %   \Function{Euclid}{$a, b$} \Comment{The g.c.d. of a and b}
  %     \State $r\gets a\bmod b$
  %     \While{$r\not=0$} \Comment{We have the answer if r is 0}
  %       \State $a\gets b$
  %       \State $b\gets r$
  %       \State $r\gets a\bmod b$
  %     \EndWhile
  %     \State \textbf{return} $b$ \Comment{The gcd is b}
  %   \EndFunction
  % \end{algorithmic}
  %
  % pseudo não usa uma "linguagem" própria desse tipo; ao invés disso,
  % ela oferece comandos para a formatação direta de palavras-chave,
  % variáveis, indentação etc. Um exemplo ("\\", "\\+" e "\\-" controlam
  % as quebras de linha e a indentação):
  %
  % \begin{pseudo}
  %    \kw{Function} \fn{Euclid}(a, b) \ct{The g.c.d. of a and b} \\+
  %      $r\gets a\bmod b$ \\
  %      \kw{while} $r\not=0$ \ct{We have the answer if r is 0} \\+
  %        $a\gets b$ \\
  %        $b\gets r$ \\
  %        $r\gets a\bmod b$ \\-
  %      \kw{end} \\
  %      \kw{return} $b$ \ct{The gcd is b} \\-
  %    \kw{end}
  % \end{pseudo}

  \usepackage{listings}
  \usepackage{lstautogobble}

  % O pacote listings não lida bem com acentos! No caso dos caracteres acentuados
  % usados em português é possível contornar o problema com a tabela abaixo.
  % From https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings#Encoding_issue
  \lstset{literate=
    {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
    {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
    {à}{{\`a}}1 {è}{{\`e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
    {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
    {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
    {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
    {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
    {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
    {Ã}{{\~A}}1 {ã}{{\~a}}1 {Õ}{{\~O}}1 {õ}{{\~o}}1
    {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
    {ű}{{\H{u}}}1 {Ű}{{\H{U}}}1 {ő}{{\H{o}}}1 {Ő}{{\H{O}}}1
    {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
    {€}{{\euro}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
    {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1
  }

  % Opções default para o pacote listings
  % Ref: http://en.wikibooks.org/wiki/LaTeX/Packages/Listings
  \lstset{
    columns=[l]fullflexible,            % do not try to align text with proportional fonts
    basicstyle=\footnotesize\ttfamily,  % the font that is used for the code
    numbers=left,                       % where to put the line-numbers
    numberstyle=\footnotesize\ttfamily, % the font that is used for the line-numbers
    stepnumber=1,                       % the step between two line-numbers. If it's 1 each line will be numbered
    numbersep=20pt,                     % how far the line-numbers are from the code
    autogobble,                         % ignore irrelevant indentation
    commentstyle=\color{Brown}\upshape,
    stringstyle=\color{black},
    identifierstyle=\color{DarkBlue},
    keywordstyle=\color{cyan},
    showspaces=false,                   % show spaces adding particular underscores
    showstringspaces=false,             % underline spaces within strings
    showtabs=false,                     % show tabs within strings adding particular underscores
    %frame=single,                       % adds a frame around the code
    framerule=0.6pt,
    tabsize=2,                          % sets default tabsize to 2 spaces
    captionpos=b,                       % sets the caption-position to bottom
    breaklines=true,                    % sets automatic line breaking
    breakatwhitespace=false,            % sets if automatic breaks should only happen at whitespace
    escapeinside={\%*}{*)},             % if you want to add a comment within your code
    backgroundcolor=\color[rgb]{1.0,1.0,1.0}, % choose the background color.
    rulecolor=\color{darkgray},
    extendedchars=true,
    inputencoding=utf8,
    xleftmargin=30pt,
    xrightmargin=10pt,
    framexleftmargin=25pt,
    framexrightmargin=5pt,
    framesep=5pt,
  }

  % Um exemplo de estilo personalizado para listings (tabulações maiores)
  \lstdefinestyle{wider} {
    tabsize = 4,
    numbersep=15pt,
    xleftmargin=25pt,
    framexleftmargin=20pt,
  }

  % Outro exemplo de estilo personalizado para listings (sem cores)
  \lstdefinestyle{nocolor} {
    commentstyle=\color{darkgray}\upshape,
    stringstyle=\color{black},
    identifierstyle=\color{black},
    keywordstyle=\color{black}\bfseries,
  }

  % Um exemplo de definição de linguagem para listings (XML)
  \lstdefinelanguage{XML}{
    morecomment=[s]{<!--}{-->},
    morecomment=[s]{<!-- }{ -->},
    morecomment=[n]{<!--}{-->},
    morecomment=[n]{<!-- }{ -->},
    morestring=[b]",
    morestring=[s]{>}{<},
    morecomment=[s]{<?}{?>},
    morekeywords={xmlns,version,type}% list your attributes here
  }

  % A package listings tem seu próprio mecanismo para a criação de
  % captions, lista de programas etc. Neste modelo não usamos esses
  % recursos (veja mais abaixo), mas utilizamos estes nomes:
  \addto\extrasbrazil{%
    \gdef\lstlistlistingname{Lista de programas}%
    \gdef\lstlistingname{Programa}%
  }
  \addto\extrasbrazilian{%
    \gdef\lstlistlistingname{Lista de programas}%
    \gdef\lstlistingname{Programa}%
  }
  \addto\extrasenglish{%
    \gdef\lstlistlistingname{List of Programs}%
    \gdef\lstlistingname{Program}%
  }

  % Novo tipo de float para programas, possível graças à package float
  % ou floatrow.
  % Observe que a lista de floats de cada tipo é criada automaticamente
  % pela package float/floatrow, mas precisamos:
  %  1. Definir o nome do comando ("\begin{program}")
  %  2. Definir o nome do float em cada língua ("Figura X", "Programa X")
  %  3. Definir a extensão do arquivo temporário a ser usada. Pode ser
  %     qualquer coisa, desde que não haja repetições. Aqui, usamos "lop";
  %     lembre-se que LaTeX já usa várias outras, como "lof", "lot" etc.,
  %     então seja cuidadoso na escolha!
  %  4. Acrescentar os comandos correspondentes em paginas-preliminares.tex

  \@ifpackageloaded{floatrow}
    {
      \ifcsundef{chapter}
          % O novo ambiente se chama "program" ("\begin{program}") e a extensão
          % temporária é "lop"
          {\DeclareNewFloatType{program}{placement=htbp,fileext=lop}}
          {\DeclareNewFloatType{program}{placement=htbp,fileext=lop,within=chapter}}

      % Ajusta ligeiramente o espaçamento do estilo "ruled".
      \DeclareFloatVCode{customrule}{{\kern 0pt\hrule\kern 2.5pt\relax}}
      \floatsetup[program]{style=ruled,precode=customrule}
    }
    {
      % Não temos a package floatrow; vamos assumir que temos a package float.

      % O estilo padrão do novo float a ser criado (veja mais sobre isso na
      % documentação da package float). Para "program" usamos "ruled", mas
      % para outros floats provavelmente é melhor usar o mesmo formato de
      % Figuras e Tables (plain).
      \floatstyle{ruled}

      \ifcsundef{chapter}
          % O novo ambiente se chama "program" ("\begin{program}") e a extensão
          % temporária é "lop"
          {\newfloat{program}{htbp}{lop}}
          {\newfloat{program}{htbp}{lop}[chapter]}

      % Retorna o estilo dos floats para o padrão
      \floatstyle{plain}
    }

  \captionsetup*[program]{style=ruled,position=top}

  % "Program X / Programa X" e "Lista de programas / List of Programs"
  \floatname{program}{\lstlistingname}
  \gdef\programlistname{\lstlistlistingname}

  % Se um programa é maior que uma página, ele não pode ser inserido em
  % um float. Nesse caso, vamos criar o ambiente "programruledcaption",
  % que cria a mesma estrutura visual e os mesmos captions que os floats
  % do tipo "program", mas sem ser um float. Para isso, vamos usar recursos
  % da package framed (a package tcolorbox poderia ter sido usada também).
  %
  % Observe que "programruledcaption" funciona *apenas* para os floats do
  % tipo "program". Se quiser criar algo similar para outro tipo de float,
  % você vai precisar criar um novo comando ("myfloatruledcaption")
  % copiando os comandos abaixo e modificando-os conforme necessário.
  \newsavebox{\programCaptionTextBox}
  \usepackage{framed}
  \newenvironment{programruledcaption}[2][]{
    % All spacing measurements were adjusted to visually reproduce
    % the float captions
    \setlength\fboxsep{0pt}

    % topsep means space before AND after
    \setlength\topsep{.28\baselineskip plus .3\baselineskip minus 0pt}

    \vspace{.3\baselineskip} % Some extra top space

    % For whatever reason, the framed package actually calls "\captionof"
    % multiple times, messing up the counter. We need to prevent this,
    % so we put the caption in a box once and reuse the box.

    \savebox{\programCaptionTextBox}{%
      \parbox[b]{\textwidth}{%
        \ifstrempty{#1}
          {\captionof{program}[#2]{#2}}%
          {\captionof{program}[#1]{#2}}%
      }
    }

    \def\fullcaption{
      \vspace*{-.325\baselineskip}
      \noindent\usebox{\programCaptionTextBox}%
      \vspace*{-.56\baselineskip}%
      \kern 2pt\hrule\kern 2pt\relax
    }

    \def\FrameCommand{
      \hspace{-.007\textwidth}%
      \CustomFBox
        {\fullcaption}
        {\vspace{.13\baselineskip}}
        {.8pt}{.4pt}{0pt}{0pt}
    }

    \def\FirstFrameCommand{
      \hspace{-.007\textwidth}%
      \CustomFBox
        {\fullcaption}
        {\hfill\textit{cont}\enspace$\longrightarrow$}
        {.8pt}{0pt}{0pt}{0pt}
    }

    \def\MidFrameCommand{
      \hspace{-.007\textwidth}%
      \CustomFBox
        {$\longrightarrow$\enspace\textit{cont}\par\vspace*{.3\baselineskip}}
        {\hfill\textit{cont}\enspace$\longrightarrow$}
        {0pt}{0pt}{0pt}{0pt}
    }

    \def\LastFrameCommand{
      \hspace{-.007\textwidth}%
      \CustomFBox
        {$\longrightarrow$\enspace\textit{cont}\par\vspace*{.3\baselineskip}}
        {\vspace{.13\baselineskip}}
        {0pt}{.4pt}{0pt}{0pt}
    }

    \MakeFramed{\FrameRestore}

  }{
    \endMakeFramed
  }
}{} % iftoggle{IMElistings}

\iftoggle{IMEpseudocode}{
  \iftoggle{IMElistings}
  {}
  {
    \ClassWarningNoLine{imelooks}
      {%
        *************************************************************\MessageBreak
        Requested pseudocode support but not the listings package;\MessageBreak
        Unless you load listings elsewhere, this will cause problems!\MessageBreak
        *************************************************************
      }
  }

  % Carrega a "linguagem" pseudocode para listings
  \appto{\lstaspectfiles}{,lstpseudocode.sty}
  \appto{\lstlanguagefiles}{,lstpseudocode.sty}
  \lstloadaspects{simulatex,invisibledelims,pseudocode}
  \lstloadlanguages{[base]pseudocode,[english]pseudocode,[brazilian]pseudocode}

  % Estilo padrão para a "linguagem" pseudocode
  \lstdefinestyle{pseudocode}{
    basicstyle=\rmfamily\small,
    commentstyle=\itshape,
    keywordstyle=\bfseries,
    identifierstyle=\itshape,
    % as palavras "function" e "procedure"
    procnamekeystyle=\bfseries\scshape,
    % funções precedidas por function/procedure ou com \func{}
    procnamestyle=\ttfamily,
    specialidentifierstyle=\ttfamily\bfseries,
  }
  \lstset{defaultdialect=[english]{pseudocode}}
}{} % iftoggle{IMEpseudocode}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% PÔSTERES E APRESENTAÇÕES %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Nos pôsteres e apresentações, os triângulos às vezes ficam de tamanhos
% diferentes com pdflatex e lualatex; para contornar isso, vamos (1)
% redimensionar para o tamanho do \strut e (2) redimensionar para o
% tamanho desejado.
\newcommand\@IMEcharscale[2]{%
    \bgroup
    \scalebox{#1}{\resizebox*{!}{\totalheightof{\strut}}{#2}}%
    \egroup
}

\iftoggle{IMEslides}{

  \setbeamertemplate{caption}[numbered]

  \usetheme[sectionpage=progressbar,
            subsectionpage=none,
            numbering=fraction,
            progressbar=frametitle]{metropolis}

  % Default 2.2ex; since we change the font, this changes too,
  % so let's set a value in pt.
  \setlength{\metropolis@frametitle@padding}{11pt}

  % Beamer assumes math fonts are "bad" and performs some substitutions
  % (which seems to be a bad idea IMHO). Unfortunately, that causes
  % problems with LibertinusT1Math. This "theme" makes beamer not mess
  % with the math font.
  \usefonttheme{professionalfonts}

  % As margens default são muito grandes
  \setbeamersize{
    text margin left=.03\paperwidth,
    text margin right=.05\paperwidth
  }

  \usefonttheme{structurebold}
  \useinnertheme{circles}

  \setlength{\metropolis@progressinheadfoot@linewidth}{2.5pt}
  \setlength{\metropolis@titleseparator@linewidth}{0pt}

  % Customizando "itemize" (bold/itálico, formato dos bullets, margens)
  \setbeamerfont{itemize/enumerate body}{series=\bfseries}
  \setbeamerfont{itemize/enumerate subbody}{series=\mdseries}
  \setbeamerfont{itemize/enumerate subsubbody}{shape=\itshape}

  \setbeamertemplate{itemize item}
    {\raisebox{-.05em}{\@IMEcharscale{.38}{\textbf{\textbullet}}}}

  \setbeamertemplate{itemize subitem}
    {%
      \raisebox{.4\totalheight}
        {\@IMEcharscale{.26}{\ensuremath{\blacktriangleright}}}%
    }

  \setbeamertemplate{itemize subsubitem}
    {\raisebox{.02em}{\@IMEcharscale{.3}{\textbf{\guillemotright}}}}

  \setbeamertemplate{bibliography item}
    {%
      \hspace{.1em}\raisebox{.4\totalheight}
        {\@IMEcharscale{.25}{\ensuremath{\blacktriangleright}}}%
    }

  % A margem esquerda das listas de itens no beamer são um tanto exageradas
  \addtolength{\leftmargini}{-.9em}
  \addtolength{\leftmarginii}{-1.3em}
  \addtolength{\leftmarginiii}{-1em}
  \addtolength{\labelsep}{-.3em}


  % Inspirado no comando \narrowragged da package varwidth.
  %
  % Num texto normal, os parágrafos costumam ser justificados. Em uma
  % apresentação, os parágrafos são muito curtos (1-3 linhas), então
  % justificar não é tão bom e, por isso, beamer usa parágrafos
  % ragged right.
  %
  % De forma similar, em um texto normal, a última linha de um parágrafo
  % pode ser bastante curta. Isso também é problemático em uma apresentação,
  % mas beamer não trata isso de forma especial. Aqui, incentivamos LaTeX
  % a fazer as linhas do parágrafo um pouco mais curtas para evitar que a
  % última fique curta demais. Além disso, fazemos LaTeX preferir não
  % hifenizar palavras se possível. Os valores dos parâmetros são chutes :)
  % mas devem funcionar razoavelmente.
  \RaggedRightRightskip 1em plus .3\textwidth minus 1em\relax
  \advance\RaggedRightRightskip by 0pt plus 2em\relax
  \RaggedRightParfillskip 0pt plus .2\textwidth minus 0pt\relax
  \hyphenpenalty=600


  % Normalmente, beamer não utiliza os "labels" normais na bibliografia;
  % ao invés disso, ele coloca ícones indicando o tipo de item. Isso
  % funciona corretamente na configuração padrão e usando bibtex, mas
  % gera alguns problemas com biblatex ou quando utilizamos "labels"
  % personalizados, como os triângulos que definimos abaixo.
  %
  % Versões mais novas de beamer + biblatex + latex usam hooks para
  % ajustar o tamanho dos labels, resolvendo a incompatibilidade com
  % biblatex. Ainda assim, há problemas com nosso label personalizado.
  % Aqui, aplicamos duas correções:
  %
  % 1. Detectamos se estamos usando uma versão mais antiga de biblatex
  %    (sem suporte a hooks) e, se sim, imitamos a configuração das
  %    versões mais novas, veja
  %    https://github.com/josephwright/beamer/commit/2a81ef0c0172a4ba7ee11676a177c7f6fd21cf3d
  %
  %    TODO: Remover isto quando arxiv usar TeXLive >= 2021 e ubuntu 20.04
  %          (focal) for descontinuada (abril de 2025).
  %
  % 2. Ajustamos bibhang para que, independentemente do tamanho do label,
  %    as linhas subsequentes estejam alinhadas à esquerda.

  % O item 1 da explicação acima
  \AtEndPreamble{
    \@ifpackagelater{biblatex}{2020/08/23}
      {}
      {
        \ifboolexpr
          {
               test {\ifcsdef{blx@file@numeric.bbx}}
            or test {\ifcsdef{blx@file@alphabetic.bbx}}
          }
          {
            \mode<presentation>{%
              \setbeamertemplate{bibliography item}{\insertbiblabel}%
            }
          }{}

        \ifboolexpr
          {
               test {\ifcsdef{blx@file@authoryear.bbx}}
            or test {\ifcsdef{blx@file@authortitle.bbx}}
          }
          {
            \mode<presentation>{%
              \pretocmd{\bibsetup}{%
                \newlength{\beamer@bibiconwidth}%
                \settowidth\beamer@bibiconwidth{\usebeamertemplate*{bibliography item}}%
                \setlength{\labelwidth}{-\beamer@bibiconwidth}%
                \addtolength{\labelwidth}{2\labelsep}%
                \addtolength{\bibhang}{\labelsep}% desnecessário, vamos redefinir abaixo
              }{}{}%
            }%
          }{}
      }
  }

  \AtEndPreamble{
    \@ifpackageloaded{biblatex}
      {
        % labelsep por padrão é MUITO grande
        \mode<presentation>{%
          \pretocmd{\bibsetup}{\setlength{\labelsep}{.2em}}{}{}%
        }

        % O item 2 da explicação acima
        \ifboolexpr
          {
               test {\ifcsdef{blx@file@authoryear.bbx}}
            or test {\ifcsdef{blx@file@authortitle.bbx}}
          }
          {
            \mode<presentation>{%
              \apptocmd{\bibsetup}{%
                \setlength{\bibhang}{\beamer@bibiconwidth}%
              }{}{}%
            }%
          }{}
      }{}
  }


  %%%%%%%%%%%%%%%%%%%%%%%%% COMANDOS AUXILIARES PARA %%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%%%%%%%%%%%%%%%%%%%%%% A "CAPA" DA APRESENTAÇÃO %%%%%%%%%%%%%%%%%%%%%%%%%%%

  \RequirePackage{qrcode}

  \newcommand\qrcodeurl[1]{\gdef\@IMEqrcodeURL{#1}}

  \newcommand\showqrcode{
    \ifcsvoid{@IMEqrcodeURL}
      {}
      {
        \begin{frame}[plain]
          \vfill
          \bgroup
          \centering
          \qrcode[height=.8\paperheight,level=H]{\@IMEqrcodeURL}\par
          \egroup
          \vfill
        \end{frame}
      }
  }

  \newtoggle{@IMEqrcodeInTOC}
  \toggletrue{@IMEqrcodeInTOC}

  \newcommand\qrcodeintoc{\toggletrue{@IMEqrcodeInTOC}}
  \newcommand\noqrcodeintoc{\togglefalse{@IMEqrcodeInTOC}}

  \newcommand\@IMEqrcode{
    \ifboolexpr
      { togl {@IMEqrcodeInTOC} and not test {\ifcsvoid{@IMEqrcodeURL}} }
      {
        \vskip 2\baselineskip plus 1\baselineskip minus 2.5\baselineskip
        \bgroup
        \centering
        \hfill\qrcode[height=.27\paperheight,level=H]{\@IMEqrcodeURL}\par
        \egroup
      }
      {}
  }

  \newcommand\@IMEqrcodeSpace{
    \ifboolexpr
      { togl {@IMEqrcodeInTOC} and not test {\ifcsvoid{@IMEqrcodeURL}} }
      {
        \vskip 2\baselineskip plus 1\baselineskip minus 2.5\baselineskip
        \rule{0pt}{.27\paperheight}\par
      }
      {}
  }

  \gdef\@IMEtocColumnSplit{0}
  \newcommand\toccolumnsplit[1]{\gdef\@IMEtocColumnSplit{#1}}

  \newcommand\overview{
    \ifnumequal{\@IMEtocColumnSplit}{0}
      {\tableofcontents\@IMEqrcode}
      {
        \begin{columns}[T]
          \column{.45\textwidth}
            \tableofcontents[sections={1-\@IMEtocColumnSplit}]
          \column{.45\textwidth}
            \tableofcontents[sections={\the\numexpr 1
                                       + \@IMEtocColumnSplit\relax-}]

            \@IMEqrcode
        \end{columns}
      }
  }

  \newcommand{\intermezzo}{
    \ifnumequal{\@IMEtocColumnSplit}{0}
      {\tableofcontents[currentsection]\@IMEqrcodeSpace}
      {
        \begin{columns}[T]
          \column{.45\textwidth}
            \tableofcontents[currentsection,sections={1-\@IMEtocColumnSplit}]
          \column{.45\textwidth}
            \tableofcontents[currentsection,
                             sections={\the\numexpr 1
                                       + \@IMEtocColumnSplit\relax-}]

            \@IMEqrcodeSpace
        \end{columns}
      }
  }

  \newcommand\titlebgimage[1]{
    \gdef\@IMEtitleBgImage{%
        \noindent\begin{minipage}[b][\paperheight][b]{\paperwidth}
          \vfill
          \centering#1\par
        \end{minipage}%
    }
  }

  % .7\paperwidth porque o lado direito do pano de fundo é muito escuro
  \newcommand\logos[1]{
    \gdef\@IMElogos{%
        \noindent\hspace{.05\paperwidth}%
        \begin{minipage}[b][\paperheight][b]{.7\paperwidth}
            \vfill
            #1\par
            \vspace{.3\baselineskip}
        \end{minipage}%
    }
  }

  \renewcommand\maketitle{
    {
      \thispagestyle{empty}
      % Traz o título para cima
      \addtobeamertemplate{title}{\vspace*{-3\baselineskip}}{}
      \addtobeamertemplate{title separator}%
                          {\vspace*{-.5\baselineskip}}%
                          {\vspace*{-\baselineskip}}

      \definecolor{bggray}{RGB}{238,238,236}
      \setbeamercolor{background canvas}{bg=bggray}
      \setbeamercolor{background}{bg=}
      % Duas minipages sobrepostas, uma com a imagem de
      % fundo e a outra com os logotipos das agências
      % Precisa estar dentro das minipages porque fica
      % mais fácil fazer o alinhamento vertical
      \setbeamertemplate{background}{%
        \ifcsvoid{@IMEtitleBgImage}{}{\@IMEtitleBgImage\hspace{-\paperwidth}}
        \ifcsvoid{@IMElogos}{}{\@IMElogos}%
      }

      \begin{frame}\titlepage\end{frame}
    }
  }

  % Há um bug em beamer, no arquivo beamerbasetoc.sty, na definição da
  % macro \beamer@sectionintoc. Essa macro faz \hbox{\vbox{...}} para
  % cada item do sumário. O problema é que, se alguma das entradas do
  % sumário tem mais de uma linha, o espaçamento entre essa entrada e
  % a entrada anterior fica errado (ligeiramente menor). Normalmente
  % esse problema não chama muito a atenção, mas se há muitos itens
  % (e, portanto, o espaço entre eles é pequeno) ou se colocamos o
  % sumário em uma minipage ou um ambiente em colunas (que minimiza o
  % espaçamento vertical), o resultado é ruim.
  %
  % \beamer@subsectionintoc e \beamer@subsubsectionintoc não fazem
  % \hbox{\vbox{...}}; num teste preliminar, remover esses comandos
  % de \beamer@sectionintoc parece funcionar. Outra solução seria
  % acrescentar um \strut: \hbox{\vbox{\strut ...}}. Aqui, no entanto,
  % contornamos o problema acrescentando o \strut em outro lugar, que
  % é mais simples de fazer e (esperemos!) não vai causar problemas.
  % Bug report: https://github.com/josephwright/beamer/issues/524
  \pretocmd{\beamer@tocact}{\strut}{}{}

  % Remove ícones de navegação
  \beamertemplatenavigationsymbolsempty


  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CORES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  % Some reasonable defaults:
  \setbeamercolor{normal text}{fg=Blackish}
  % 1. blocks
  \setbeamercolor{block title}{use=structure,fg=structure.fg,bg=structure.fg!20!bg}
  \setbeamercolor{block body}{parent=normal text,use=block title,bg=block title.bg!50!bg}
  % 2. example blocks
  \setbeamercolor{block title example}{use=example text,fg=example text.fg,bg=example text.fg!20!bg}
  \setbeamercolor{block body example}{parent=normal text,use=block title example,bg=block title example.bg!50!bg}

  \setbeamercolor{structure}{fg=DarkRed}
  \setbeamercolor{alerted text}{fg=DarkRed}
  \setbeamercolor{progress bar}{fg=DarkRed!40!red}
  \setbeamercolor{separation line}{bg=DarkRed!40!red,fg=}

  \setbeamercolor{palette primary}{fg=white,bg=DarkRed!80!black}
  \setbeamercolor{palette secondary}{fg=DarkRed, bg=SandyPaper}
  \setbeamercolor{palette quarternary}{fg=Blackish, bg=SandyPaper}

  \iftoggle{IMEgreeny}{
      \setbeamercolor{structure}{fg=InterSCity}
      %\setbeamercolor{alerted text}{fg=PastelGreen!80!black}
      %\setbeamercolor{alerted text}{fg=DarkRed} % same as default
      \setbeamercolor{progress bar}{fg=InterSCity!75!green}
      \setbeamercolor{separation line}{bg=PastelGreen,fg=}

      \setbeamercolor{palette primary}{fg=white,bg=DarkInterSCity}
      %\setbeamercolor{palette secondary}{fg=DarkRed, bg=SandyPaper} % same as default
      %\setbeamercolor{palette quarternary}{fg=Blackish, bg=SandyPaper} % same as default
  }{}

  \iftoggle{IMEsandy}{
      % Cores default para blocos
      % block body preto é melhor para impressão
      \setbeamercolor{block body}{fg=black,bg=SandyPaper}
      %\setbeamercolor{block body}{fg=BrownishGreen!50!black,bg=SandyPaper}
      \setbeamercolor{block title}{fg=BrownishGreen!50!black,bg=SandyPaper!90!black}
  }{}

  \iftoggle{IMEbluey}{
      \setbeamercolor{block title}{use=structure,fg=white,bg=imesoftblue}
      \setbeamercolor{block body}{fg=black,bg=SandyPaper}

      \setbeamercolor{structure}{fg=imeblue}
      \setbeamercolor{alerted text}{fg=imered}
      \setbeamercolor{progress bar}{fg=imeyellow}
      \setbeamercolor{separation line}{bg=imeyellow,fg=}

      \setbeamercolor{palette primary}{fg=white,bg=imeblue}
      \setbeamercolor{palette secondary}{fg=imered, bg=SandyPaper}
      %\setbeamercolor{palette quarternary}{fg=Blackish, bg=SandyPaper} % same as default
  }{}

  % Proofs, theorems etc. don't change with the different themes
  %
  % Cores especiais para bloco proof.
  % Não existe um template específico para definir as
  % cores do bloco proof, então fazemos de outra maneira
  \addtobeamertemplate{proof begin}{%
      \setbeamercolor{block title}{fg=black,bg=orange!50!white}
      \setbeamercolor{block body}{fg=orange!80!black,bg=orange!20!white}
  }{}

  % Não é boa ideia fazer "\addtobeamertemplate{theorem begin}" para definir
  % cores para teoremas porque essa template vale para theorem, corollary,
  % definition, fact e example e não tem como fazer override depois. Vamos
  % usar isto no lugar
  \AtBeginEnvironment{theorem}{
      \setbeamercolor{block title}{use=example text,fg=white,bg=example text.fg!75!black}
      \setbeamercolor{block body}{parent=normal text,use=block title example,bg=block title example.bg!50!bg}
  }{}

  % Cor especial para definition
  \AtBeginEnvironment{definition}{%
      \setbeamercolor{block title}{fg=black,bg=brown!80!red!70!white}
      \setbeamercolor{block body}{fg=brown!70!black,bg=brown!80!red!30!white}
  }{}

  % Exemplo de novo tipo de teorema (proposition) com cor personalizada
  \newtheorem{proposition}{Proposition}
  \AtBeginEnvironment{proposition}{
      \setbeamercolor{block title}{fg=black,bg=yellow!50!black!50!white}
      \setbeamercolor{block body}{fg=yellow!50!black,bg=yellow!50!black!30!white}
  }{}

  \usepackage{appendixnumberbeamer}
  % Desabilita a cor de rodapé
  \setbeamercolor{footline}{fg=,bg=}

  % Com lualatex/xelatex, o tema metropolis usa a fonte Fira;
  % aqui, voltamos à fonte libertinus, carregada anteriormente
  \iftoggle{IMEfonts}{
    \let\rmdefault\LibertinusSerifFont
    \let\sfdefault\LibertinusSansFont
    \let\ttdefault\SourceCodeProFont
    \let\mddefault\LibertinusMDDefault
    \let\bfdefault\LibertinusBFDefault
    \let\updefault\LibertinusUPdefault
    \let\itdefault\LibertinusITdefault
    \let\scdefault\LibertinusSCdefault
    \let\familydefault\LibertinusFamily
    \let\seriesdefault\LibertinusSeries
    \let\shapedefault\LibertinusShape
    \let\mdseries@rm\LibertinusMDrm
    \let\mdseries@sf\LibertinusMDsf
    \let\mdseries@tt\LibertinusMDtt
    \let\bfseries@rm\LibertinusBFrm
    \let\bfseries@sf\LibertinusBFsf
    \let\bfseries@tt\LibertinusBFtt
  }{}

}{} % \iftoggle{IMEslides}

\iftoggle{IMEposter}{
    % Coloca uma imagem no rodapé à direita
    \newcommand{\footimage}[1]{%
        \ifstrempty{#1}
          {}
          {%
            \tikz[overlay,remember picture]
            \node[anchor=south east] at
            ([xshift=-1.5cm, yshift=3mm] current page.south east) {#1};%
          }%
    }

    \parindent=0pt
    \parskip=0pt
    \setstretch{1.1}

    \renewcommand*\familydefault{\sfdefault}

    \iftoggle{IMEspacing}
        {\geometry{left=1.5cm,right=1.5cm,top=0cm,bottom=0cm}}
        {}

    \usepackage[poster,skins]{tcolorbox}

    \tcbposterset{
      fontsize = 32pt,
      no coverage,
    }

    \tcbset{
        skin=enhanced,
        valign=center,
        before upper = \evenRaggedRight,
        fonttitle = \large,
        top=.7\baselineskip,
        bottom=.7\baselineskip,
        left=.9\baselineskip,
        right=.9\baselineskip,
        toptitle=.1\baselineskip,
        bottomtitle=.05\baselineskip,
        lefttitle=.4\baselineskip,
        righttitle=.6\baselineskip,
        colframe = IMEframe,
        colback = IMEbg,
    }

    \tcbset{
        smallmargins/.style = {
            top=.3\baselineskip,
            bottom=.3\baselineskip,
            left=.4\baselineskip,
            right=.4\baselineskip,
        },
        titlebox/.style = {
            before upper = \centering\huge\rmfamily\bfseries,
            colback=IMEtitlebg, coltext=white, grow sidewards by = 1.5cm,
            sharp corners, boxsep=10mm, left=.5cm, right=.5cm,
            top=.3\baselineskip, bottom=.3\baselineskip,
            borderline south={15pt}{-5pt}{IMEtitleBorder},
        },
        footerbox/.style = {
            before upper = \rmfamily\bfseries,
            colback=IMEfooterbg, coltext=white, grow sidewards by = 1.5cm,
            sharp corners, boxsep=4mm, left=1.1cm, right=1.1cm,
            top=.3\baselineskip, bottom=0pt,
            borderline north={15pt}{-5pt}{IMEtitleBorder},
        },
    }

    \setlist{
        first={\evenRaggedRight},
        parsep=0pt,
        itemsep=0pt,
        topsep=0pt,
        partopsep=0pt,
    }

    \setlist[itemize,1]{
      left = 0pt .. .8em,
      label={\color{IMElabel}\raisebox{.1em}{%
             \@IMEcharscale{.26}{\ensuremath{\blacktriangleright}}}}
    }

    \setlist[itemize,2]{
      before*={\footnotesize},
      left = -5pt .. .8em,
      label={\color{IMElabel}\raisebox{-.1em}{%
             \@IMEcharscale{.4}{\ensuremath{\bullet}}}}
    }

    \setlist[itemize,3]{
      before*={\footnotesize\itshape},
      left = -1pt .. .95em,
      label={\color{IMElabel}\raisebox{.05em}{%
             \@IMEcharscale{.3}{\normalfont\textbf{\guillemotright}}}}
    }

    \evenRaggedRight
    \hyphenpenalty=600
}{} % \iftoggle{IMEposter}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% CABEÇALHOS E RODAPÉS (REPORT/TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEreport}{

  % Permite saber o número total de páginas; útil para colocar no
  % rodapé algo como "página 3 de 10" com "\thepage\ de \zpageref{LastPage}"
  %\RequirePackage{zref-lastpage,zref-user}

  % Permite definir cabeçalhos e rodapés
  \RequirePackage{fancyhdr}

  % A formatação dos cabeçalhos/rodapés envolve duas coisas:
  %
  % 1. Definir qual texto deve ser impresso em cada página (nome
  %    do capítulo ou seção, nome do autor, número da página etc.)
  %
  % 2. Imprimir esse texto no lugar correto (esquerda, direita ou
  %    centro, cabeçalho ou rodapé)
  %
  % A definição do texto a imprimir é complexa, pois a preparação dos
  % cabeçalhos/rodapés acontece de maneira independente da construção do
  % restante da página. Textos fixos como, digamos, o nome do livro ou
  % do seu autor, não trazem dificuldades. Já textos variáveis, como o
  % nome do capítulo ou seção, o número da página etc. envolvem a
  % passagem de informações sobre a página atual para o mecanismo de
  % construção dos cabeçalhos.
  %
  % Isso é feito através de "variáveis" especiais chamadas "marks". O uso
  % mais comum das marks é armazenar o nome do capítulo e da seção atuais:
  % a cada novo capítulo ou seção, os comandos \chaptermark e \sectionmark
  % são executados (isso é automático, você não precisa fazer nada); esses
  % comandos definem uma "mark" com o nome do capítulo/seção a ser usado
  % nos cabeçalhos/rodapés. Assim, modificando a definição dos comandos
  % \chaptermark e \sectionmark, é possível modificar o texto a ser
  % incluído nos cabeçalhos/rodapés.
  %
  % Definido o conteúdo das marks, o lugar em que cada texto é impresso
  % é definido com os comandos \fancyhead e \fancyfoot. "RO" significa
  % "Right side of Odd pages"; "LE" significa "Left side of Even pages" etc.
  %
  % LaTeX por padrão tem duas "marks": "\leftmark" e "\rightmark". Elas
  % têm esses nomes porque originalmente eram usadas para armazenar o
  % conteúdo a ser impresso nas páginas pares e ímpares. Isso, no entanto,
  % não é obrigatório; a escolha desses nomes foi bastante infeliz. Para
  % definir o conteúdo dessas marks, usam-se os comandos \markboth{A}{B}
  % (define \leftmark como A e \rightmark como B) e \markright{C} (define
  % \rightmark como C). Não há o comando \markleft.
  %
  % O procedimento de definição dos cabeçalhos e rodapés, portanto, envolve:
  %
  % 1. Redefinir \chaptermark e \sectionmark (ambas recebem um parâmetro,
  %    que é o nome do capítulo/seção) para fazê-los executar \markboth e
  %    \markright, inserindo o conteúdo desejado nas marks;
  %
  % 2. Usar \fancyhead e \fancyfoot para definir os cabeçalhos e rodapés
  %    usando o conteúdo de \leftmark e \rightmark.
  %
  % Além das marks, é possível usar também as variáveis \thepage (número
  % da página), \thechapter (número do capítulo) e \thesection (número da
  % seção).
  %
  % Neste modelo, modificamos chaptermark e sectionmark para armazenar
  % o número e nome do capítulo em leftmark e o número e nome da seção
  % em rightmark. MAS imprimimos rightmark nas páginas pares (esquerda)
  % e leftmark nas páginas ímpares (direita)!
  %%%%%%%%%%

  % Sem linha separando o cabeçalho
  \renewcommand{\headrulewidth}{0pt}

  % Queremos colocar o número da página mais próximo da borda do papel (na
  % horizontal). Para isso, vamos aumentar \headwidth, somando "tamanho da
  % margem direita -10mm" (o número vai ficar a 10mm da borda).
  %
  % Observe que a package geometry define \evensidemargin, mas seu valor não
  % necessariamente corresponde ao que queremos aqui (não sei bem como nem
  % por que geometry define esse valor). Ao invés de usá-lo, vamos calcular
  % manualmente.
  %
  % A distância entre a borda esquerda/interna do papel e o início do texto
  % é dada por (1in + \hoffset + \oddsidemargin); a margem direita, portanto,
  % é dada por (\paperwidth - (1in + \hoffset + \oddsidemargin + \textwidth)).
  %
  \dimdef{\othermargin}{\paperwidth - 1in - \hoffset - \oddsidemargin - \textwidth}
  \addtolength{\headwidth}{\othermargin}
  \addtolength{\headwidth}{-10mm}

  \newcommand{\formataNumPaginas}{
    \fancyhead[RO]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
    \fancyhead[LE]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
  }

  \newcommand{\formataCabecalhosDinamicos}{
    \fancyhead[LO]{\scriptsize\MakeTextUppercase{\rightmark}}
    \fancyhead[RE]{\scriptsize\MakeTextUppercase{\leftmark}}
  }

  \fancypagestyle{mainmatter}{
    % Número e nome do capítulo no cabeçalho das páginas pares
    % (e nas ímpares quando não há seções)
    \renewcommand{\chaptermark}[1]{
      \markboth
        {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
        {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
    }

    % Número e nome da seção no cabeçalho das páginas ímpares
    \renewcommand{\sectionmark}[1]{
      \markright{\thesection\hskip 0.3em |\hskip 0.3em ##1}
    }

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % Formato para capítulos não-numerados mas que devem
  % aparecer no sumário (tipicamente, a introdução):
  \fancypagestyle{unnumberedchapter}{
    % Só o nome do capítulo/seção, sem numeração
    \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
    \renewcommand{\sectionmark}[1]{\markright{##1}}

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  \fancypagestyle{appendix}{
    \renewcommand{\chaptermark}[1]{%
      \markboth{%
        % Páginas ímpares: "Apêndice/Anexo X"
        \@chapapp\ \thechapter%
      }{%
        % Páginas pares: "X | nome do apêndice/anexo"
        \thechapter\hskip 0.3em |\hskip 0.3em ##1%
      }
    }

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % Na frontmatter e backmatter, não há números de capítulos e (em geral)
  % não há subdivisões (capítulos/seções/subseções), apenas um nível.
  % O correto, então, é usar o mesmo texto (nome do capítulo ou seção,
  % sem número) nas páginas pares ou ímpares.
  %
  % Normalmente, a bibliografia e o índice remissivo não definem os
  % cabeçalhos (não executam "chaptermark/sectionmark"), mas "forçamos"
  % isso manualmente (em bibconfig.tex e index.tex).
  \fancypagestyle{backmatter}{
    \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
    \renewcommand{\sectionmark}[1]{\markboth{##1}{##1}}

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % A página inicial de cada capítulo é automaticamente configurada para
  % o estilo "plain", então vamos definir esse estilo (colocando o número
  % de página no mesmo lugar das demais). As páginas iniciais também usam
  % esse estilo.
  \fancypagestyle{plain}{
    \fancyhf{}
    \formataNumPaginas{}
  }

}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% EPÍGRAFE (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEreport}{

  % O formato padrão do pacote epigraph é bem feinho...
  % Outra opção para epígrafes é o pacote quotchap
  \RequirePackage{epigraph}

  \setlength\epigraphwidth{.85\textwidth}

  % Sem linha entre o texto e o autor
  \setlength{\epigraphrule}{0pt}

  % Ambiente auxiliar para colocar margem à direita da epígrafe
  % (como sempre, o modo mais simples de mudar as margens de um
  % pagrágrafo é fazer de conta que é uma lista)
  \newenvironment{epShiftLeft}
    {
      \par\begin{list}{}
        {
          \leftmargin 0pt
          \labelwidth 0pt
          \labelsep 0pt
          \itemsep 0pt
          \topsep 0pt
          \partopsep 0pt
          \rightmargin 2em
        }
      \item\FlushRight
    }
    {
      \end{list}
      % O espaço padrão que epigraph coloca entre a citação
      % e o autor é muito pequeno; vamos aumentar um pouco
      \vspace*{.3\baselineskip}
    }

  \renewcommand\textflush{epShiftLeft}
  \renewcommand\sourceflush{epShiftLeft}

  \newcommand{\epigrafe}[2] {%
    \ifstrempty{#2}{
      \epigraph{\itshape #1}{}
    }{
      \epigraph{\itshape #1}{--- #2}
    }
  }

}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% DEDICATÓRIA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% A dedicatória vai em uma página separada, sem numeração,
% com o texto alinhado à direita e margens esquerda e
% superior muito grandes. Vamos fazer isso com uma minipage.

\iftoggle{IMEreport}{
  \newenvironment{dedicatoria} {
    \hypersetup{pageanchor=false} % Veja comentário em \maketitle

    \if@openright\cleardoublepage\else\clearpage\fi

    \thispagestyle{empty}
    \vspace*{140mm plus 0mm minus 100mm}
    \noindent
    \begin{FlushRight}
       \begin{minipage}[b][100mm][b]{100mm}
         \begin{FlushRight}
           \itshape
  } {
         \end{FlushRight}
       \end{minipage}\hspace*{3em}
    \end{FlushRight}
    \vspace*{50mm plus 0mm minus 10mm}
    \if@openright\cleardoublepage\else\clearpage\fi

    \hypersetup{pageanchor=true}
  }
}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% RESUMO (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEresumoabstract}{
  % A página de resumo deve existir em português e inglês; ambas as versões
  % utilizam o mesmo environment.

  \NewDocumentCommand{\resumo}{+m}{%
    \long\gdef\@resumo{#1}%

    \bgroup
    \@IMEremoveLinebreaksEtc{\@resumo}
    \IfLanguagePatterns{brazilian}
      {\hypersetup{pdfsubject={\@resumo}}}
      {\XMPLangAlt{pt}{pdfsubject={\@resumo}}}
      % XMPLangAlt undefines "\do"; this may cause
      % problems with biblatex, but we do not need
      % to worry here because we are in a group.
      % https://github.com/plk/biblatex/issues/1105
    \egroup

    \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
    \selectlanguage{brazilian}
    \begin{IMEabstract}\@resumo\end{IMEabstract}
    \egroup\egroup
  }

  \DeclareDocumentCommand{\abstract}{+m}{%
    \long\gdef\@abstract{#1}%

    \bgroup
    \@IMEremoveLinebreaksEtc{\@abstract}
    \IfLanguagePatterns{english}
      {\hypersetup{pdfsubject={\@abstract}}}
      {\XMPLangAlt{en}{pdfsubject={\@abstract}}}
      % XMPLangAlt undefines "\do"; this may cause
      % problems with biblatex, but we do not need
      % to worry here because we are in a group.
      % https://github.com/plk/biblatex/issues/1105
    \egroup

    \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
    \selectlanguage{english}
    \begin{IMEabstract}\@abstract\end{IMEabstract}
    \egroup\egroup
  }

  \NewDocumentEnvironment{IMEabstract}{} {
    \if@openright\cleardoublepage\else\clearpage\fi
    \thispagestyle{empty}

      \begin{center}\Large\bfseries\abstractname\end{center}

    \vspace*{2em plus 1em minus 1em}

    \footnotesize

    % Esse é o jeito mais simples de mudar as margens de um parágrafo:
    % faz de conta que é uma lista
    \begin{list}{}{\rightmargin 4em \leftmargin 4em}
      \item\@selfReference
    \end{list}

    \vspace*{1em plus 1em minus 0em}
  } {
    % Impede uma quebra de página entre esta linha e a próxima, ou seja,
    % entre a última linha do resumo/abstract e as palavras-chave.
    \@afterheading

    \vspace*{1em plus 1em minus .5em}

    \begingroup

        \setlength{\leftmargini}{\widthof{\textbf{\keywordsname:}\quad}}
        \setlength{\labelwidth}{\widthof{\textbf{\keywordsname:}}}
        \setlength{\labelsep}{\widthof{\quad}}

        \begin{description}
          \item[\keywordsname:]\IfLanguagePatterns{brazilian}
                               {\@keywordspt}
                               {\@keywordsen}%
        \end{description}

    \endgroup
  }

}{} % \iftoggle{IMEresumoabstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% TEXTOS PADRÃO PARA A CAPA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
    % Formatação de datas de acordo com a língua
    \RequirePackage[useregional]{datetime2}
    \DTMusemodule{brazilian}{portuges}
    \DTMnewdatestyle{month-year}{%
      \renewcommand*{\DTMdisplaydate}[4]{##2,\space##1}%
      \renewcommand*{\DTMDisplaydate}{\DTMdisplaydate}%
    }

    % \extrasLANGUAGE vs \captionsLANGUAGE: https://tex.stackexchange.com/a/354197

    % Palavras fixas a serem traduzidas
    \providecommand\keywordsname{} % Keywords / Palavras-chave
    \providecommand\programname{} % Program / Programa
    \providecommand\committeename{} % Examining committee / Comissão julgadora
    \providecommand\advisorname{} % Advisor / Orientador(a)
    \providecommand\coadvisorname{} % Co-advisor / Coorientador(a)
    \providecommand\workname{} % Report, Thesis / Tese, Dissertação, Monografia
    \providecommand\degreename{} % Masters, Doctorate, Bachelor / Mestrado, Doutorado, Bacharelado
    \providecommand\titlename{} % Master, Doctor, Bachelor / Mestre(a), Doutor(a), Bacharel
    \providecommand\@assembleLicenseText[1]{O conteúdo deste trabalho
                                            é publicado sob a licença #1}

    % Textos longos a serem traduzidos
    \providecommand\@coverTCCText{}
    \providecommand\@coverQualiText{}
    \providecommand\@coverThesisText{}
    \providecommand\@institutionBlockText{} % Só para TCC
    \providecommand\@provisionalFrontmatterText{}
    \providecommand\@finalFrontmatterText{}
    \providecommand\@institution{}

    % Este não precisa ser traduzido, o texto em inglês não utiliza
    \providecommand\@bywhom{%
      \ifdefstring{\@authorGender}{masc}
        {pelo candidato \@author}
        {pela candidata \@author}%
    }

    %%%%%%%%%% PORTUGUÊS %%%%%%%%%%
    \addto\captionsbrazilian{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMportugesmonthname{##2}\space de\space##1}%
      }%
      \renewcommand\keywordsname{Palavras-chave}%
      \renewcommand\programname{Programa}%
      \renewcommand\committeename{Comissão julgadora}%
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{%
          \ifdefstring{\@advisorGender}{masc}
            {Supervisor}
            {Supervisora}%
        }{%
          \ifdefstring{\@advisorGender}{masc}
            {Orientador}
            {Orientadora}%
        }%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Cossupervisor}
            {Cossupervisora}%
        }{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Coorientador}
            {Coorientadora}%
        }%
      }%
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Monografia}
          {\iftoggle{@qualificacao}
            {Exame de Qualificação}
            {\iftoggle{@doutorado}
              {Tese}
              {Dissertação}%
            }%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doutorado}
          {\iftoggle{@mestrado}
            {Mestrado}
            {\iftoggle{@tcc}
              {Bacharelado}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {\ifdefstring{\@authorGender}{masc}{Doutor}{Doutora}}
          {\iftoggle{@mestrado}
            {\ifdefstring{\@authorGender}{masc}{Mestre}{Mestra}}
            {\iftoggle{@tcc}
              {Bacharel}{Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Monografia Final\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Trabalho de\\
        Formatura Supervisionado%
      }%
      \renewcommand\@coverQualiText{%
        Relatório apresentado ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para exame de qualificação de\\
        \degreename{} em Ciências%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} apresentada ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para obtenção do título de\\
        \titlename{} em Ciências%
      }%
      \renewcommand\@institutionBlockText{%
        Universidade de São Paulo\\
        Instituto de Matemática e Estatística\\
        Bacharelado em Ciência da Computação%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          Esta é a versão original do texto de qualificação elaborado
          \@bywhom{}, tal como submetido à Comissão Julgadora.%
        }{%
          Esta é a versão original da \MakeTextLowercase{\workname} elaborada
          \@bywhom{}, tal como submetida à Comissão Julgadora.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        Esta versão da \MakeTextLowercase{\workname} contém as correções e alterações
        sugeridas pela Comissão Julgadora durante a defesa da versão
        original do trabalho\DTMifsaveddate{@defensedate}
        {, realizada em \DTMusedate{@defensedate}}{}.\\[1\baselineskip]
        Uma cópia da versão original está disponível no Instituto de
        Matemática e Estatística da Universidade de São Paulo.%
      }%
      \renewcommand\@institution{%
        Instituto de Matemática e Estatística,
        Universidade de São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{O conteúdo deste trabalho
                                              é publicado sob a licença #1}%
    }


    %%%%%%%%%% INGLÊS %%%%%%%%%%
    \addto\captionsenglish{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMenglishmonthname{##2},\space##1}%
      }%
      \renewcommand\keywordsname{Keywords}%
      \renewcommand\programname{Program}%
      \renewcommand\committeename{Examining Committee}
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{Supervisor}{Advisor}%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{Co-supervisor}{Coadvisor}%
      }%
      % "Tese" e "dissertação" têm sentido contrário em língua inglesa:
      % http://guides.lib.berkeley.edu/dissertations_theses
      % https://www.grad.ubc.ca/handbook-graduate-supervision/graduate-thesis
      % Como "Thesis" é o nome genérico, vamos usar para mestrado e doutorado
      %
      %%%%%
      %
      % Nomes possíveis para o TCC em inglês:
      %
      % * monograph/monography
      %     usado para trabalho de alto nível de um autor "senior",
      %     então não faz sentido para um trabalho de graduação.
      %
      % * undergraduate thesis / bachelor's thesis
      %     plausível, mas no nosso caso report parece melhor.
      %
      % * senior project / senior thesis / honor thesis
      %     usado para "TCCs" de caráter fortemente acadêmico;
      %     não é o caso aqui.
      %
      % * essay / report
      %     razoável, porque trata-se de um texto/relato
      %     sobre o projeto de TCC.
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Capstone Project Report}
          {\iftoggle{@qualificacao}
            {Qualifying Exam}
            {Thesis}%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doctorate}
          {\iftoggle{@mestrado}
            {Master's}
            {\iftoggle{@tcc}
              {Bachelor}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {Doctor}
          {\iftoggle{@mestrado}
            {Master}
            {\iftoggle{@tcc}
              {Bachelor}%
              {Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Final Essay\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Capstone Project%
      }%
      \renewcommand\@coverQualiText{%
        Report presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        for the \titlename{} of Science\\
        qualifying examination\\%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        in partial fulfillment\\
        of the requirements\\
        for the degree of\\
        \titlename{} of Science%
      }%
      \renewcommand\@institutionBlockText{%
        University of São Paulo\\
        Institute of Mathematics and Statistics\\
        Bachelor of Computer Science%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          This is the original version of the qualifying text prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }{%
          This is the original version of the \MakeTextLowercase{\workname} prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        This version of the \MakeTextLowercase{\workname} includes the corrections
        and modifications suggested by the Examining Committee during
        the defense of the original version of the work\DTMifsaveddate
        {@defensedate}{, which took place on \DTMusedate{@defensedate}}
        {}.\\[1\baselineskip]
        A copy of the original version is available at the Institute of
        Mathematics and Statistics of the University of São Paulo.%
      }%
      \renewcommand\@institution{%
        Institute of Mathematics and Statistics,
        University of São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{The content of this work is
                                              published under the #1 license}%
    }
}{} % \iftoggle{IMEthesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%% COLETA E DEFINIÇÃO DE METADADOS (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn

\iftoggle{IMEthesis}{

  % Mais de um coorientador é raro, mas pode acontecer
  \newcounter{numberOfCoadvisors}
  \NewDocumentCommand\coorientador{O{masc} m}{
    \stepcounter{numberOfCoadvisors}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}Gender}

    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}} {#2}
    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}Gender} {#1}
  }

  \NewDocumentCommand\coorientadora{m}{\coorientador[fem]{#1}}

  \newtoggle{@mestrado}
  \newtoggle{@doutorado}
  \newtoggle{@tcc}
  \newtoggle{@qualificacao}
  \newtoggle{@finalversion}

  % Opções usando LaTeX3 (veja texdoc l3keys).
  \keys_define:nn { IME / tipotese }
  {
    % Chaves à esquerda definem as variáveis à direita
    mestrado .code:n = {\@mestrado},
    mestrado .value_forbidden:n = true,
    masters .code:n = {\@mestrado},
    masters .value_forbidden:n = true,
    dissertacao .code:n = {\@mestrado},
    dissertacao .value_forbidden:n = true,
    doutorado .code:n = {\@doutorado},
    doutorado .value_forbidden:n = true,
    phd .code:n = {\@doutorado},
    phd .value_forbidden:n = true,
    doctorate .code:n = {\@doutorado},
    doctorate .value_forbidden:n = true,
    tese .code:n = {\@doutorado},
    tese .value_forbidden:n = true,
    graduacao .code:n = {\@tcc},
    graduacao .value_forbidden:n = true,
    bachelor .code:n = {\@tcc},
    bachelor .value_forbidden:n = true,
    tcc .code:n = {\@tcc},
    tcc .value_forbidden:n = true,
    quali .code:n = {\ifstrequal{#1}{true}{\toggletrue{@qualificacao}}{\togglefalse{@qualificacao}}},
    quali .default:n = {true},
    definitiva .code:n = {\ifstrequal{#1}{true}{\toggletrue{@finalversion}}{\togglefalse{@finalversion}}},
    definitiva .default:n = {true},
    provisoria .code:n = {\ifstrequal{#1}{true}{\togglefalse{@finalversion}}{\toggletrue{@finalversion}}},
    provisoria .default:n = {true},
    programa .tl_gset:N = \@program,
    program .value_required:n = true,
  }

  \NewDocumentCommand\tipotese{+m}{
    \keys_set:nn {IME/tipotese}{#1}
  }

  \keys_define:nn { IME / defesa }
  {
    data .code:n= {\DTMsavedate{@defensedate}{#1}},
    data .value_required:n = true,
    local .tl_gset:N = \@defenselocation,
    local .value_required:n = true,
  }

  \NewDocumentCommand\defesa{m}{
    \keys_set:nn {IME/defesa}{#1}
  }

  \NewDocumentCommand\fichacatalografica{+m}{
    \tl_gset:Nn \@catalogingData {#1}
  }

  \NewDocumentCommand\apoio{+m}{
    \tl_gset:Nn \@financing {#1}
  }

  \NewDocumentCommand\direitos{+m}{
    \tl_gset:Nn \@license {#1}

    \exp_args:NV \str_case:nnF \@license
    {
      {CC-BY}{\gdef\@license{\@assembleLicenseText{CC~BY~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by/4.0/}{%
        (Creative~Commons~Attribution~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by/4.0/}}
      }

      {CC-BY-NC}{\gdef\@license{\@assembleLicenseText{CC~BY-NC~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc/4.0/}}
      }

      {CC-BY-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nd/4.0/}{%
        (Creative~Commons~Attribution-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }

      {CC-BY-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-sa/4.0/}{%
        (Creative~Commons~Attribution-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-sa/4.0/}}
      }

      {CC-BY-NC-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-sa/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-sa/4.0/}}
      }

      {CC-BY-NC-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-nd/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }
    }
    % If there is no match, use the user-supplied text
    {}
  }

  \seq_gclear_new:N \@committeeMembers
  \NewDocumentCommand\banca{m}{
    \seq_gset_from_clist:Nn \@committeeMembers {#1}
  }

  \seq_gclear_new:N \@seqkeywordspt
  \NewDocumentCommand{\palavraschave}{m}{
    \seq_gset_from_clist:Nn \@seqkeywordspt {#1}

    \IfLanguagePatterns{brazilian}
      {\hypersetup{pdfkeywords={\@commakeywordspt}}}
      {} % o item "keywords" não pode ser traduzido
  }

  \seq_gclear_new:N \@seqkeywordsen
  \DeclareDocumentCommand{\keywords}{m}{
    \seq_gset_from_clist:Nn \@seqkeywordsen {#1}

    \IfLanguagePatterns{english}
      {\hypersetup{pdfkeywords={\@commakeywordsen}}}
      {} % o item "keywords" não pode ser traduzido
  }

  % Na impressão, as palavras-chave são separadas por pontos
  \newcommand*{\@keywordspt}{\seq_use:Nn \@seqkeywordspt {.\space}.}
  \newcommand*{\@keywordsen}{\seq_use:Nn \@seqkeywordsen {.\space}.}

  % Para inclusão nos metadados com hyperxmp, são separadas por vírgulas
  \newcommand*{\@commakeywordspt}{\seq_use:Nn \@seqkeywordspt {,}}
  \newcommand*{\@commakeywordsen}{\seq_use:Nn \@seqkeywordsen {,}}

  \NewDocumentCommand{\orientador}{O{masc} m}{
    \gdef\@advisor{#2}
    \gdef\@advisorGender{#1}
  }

  \NewDocumentCommand{\orientadora}{m}{\orientador[fem]{#1}}

  \NewDocumentCommand{\@doutorado}{}{
    \toggletrue{@doutorado}
    \togglefalse{@mestrado}
    \togglefalse{@tcc}
  }

  \NewDocumentCommand{\@mestrado}{}{
    \togglefalse{@doutorado}
    \toggletrue{@mestrado}
    \togglefalse{@tcc}
  }

  \NewDocumentCommand{\@tcc}{}{
    \togglefalse{@mestrado}
    \togglefalse{@doutorado}
    \toggletrue{@tcc}
  }

}{} % \iftoggle{IMEthesis}

\ExplSyntaxOff

% Às vezes é necessário forçar quebras de linha no título para a capa, mas
% essas quebras não devem aparecer em outros lugares (especialmente nos
% metadados XMP). hyperref e hyperxmp removem essas quebras automaticamente,
% mas isso pode fazer duas palavras ficarem grudadas. Estas macros "apagam"
% esses comandos de maneira mais cuidadosa.

\ExplSyntaxOn

% Primeiro definimos a regex que vamos usar. O que estamos fazendo aqui é
% "(regex1)|(regex2)|(regex3)|(regex4)"
\regex_const:Nn \@IMEbreakRegex
  {
    ( \c{break} ) % Encontra "\break"
    |
    ( \c{newline} ) % Encontra "\newline"
    |
      % Isto encontra:
      % 1. A control sequence "\linebreak" -> "\c{linebreak}"
      % 2. Opcionalmente seguida de "[NÚMERO]" -> "( \s*\x{5B}\s*\d\s*\x{5D} )?"
    ( \c{linebreak} (\s*\x{5B}\s*\d\s*\x{5D})? )
    |
      % Isto encontra:
      % 1. A control sequence "\\" (quebra de linha) -> "\c{\\}"
      % 2. Optionalmente seguida de "[...]" -> "( \s*\x{5B}\s*...\s*\x{5D} )?"
      % 3. Onde "..." é qualquer dimensão TeX válida
      %    (veja o exemplo de regex em texdoc interface3)
    ( \c{\\}
      ( \s*\x{5B}\s*
          [\+\-]?(\d+|\d*\.\d+)\s*((?i)pt|in|[cem]m|ex|[bs]p|[dn]d|[pcn]c)
        \s*\x{5D}
      )?
    )
  }

\newcommand{\@IMEremoveLinebreaksEtc}[1]{
    % Primeiro, substitui todas as quebras de linha por espaços
    \regex_replace_all:NnN \@IMEbreakRegex {\ } #1

    % Depois elimina eventuais notas de rodapé
    \regex_replace_all:nnN {\s*\c{footnote}} {\c{@gobble}} #1
    \regex_replace_all:nnN {\s*\c{thanks}} {\c{@gobble}} #1

    % Depois transforma URLs em texto simples
    \regex_replace_all:nnN {\c{url}} {\c{@firstofone}} #1
    \regex_replace_all:nnN {\c{href}} {\c{@secondoftwo}} #1

    % Substitui \par (ou uma linha em branco) por um caractere de nova linha
    \regex_replace_all:nnN {\c{par}} {\n} #1

    % Depois elimina espaços repetidos
    \regex_replace_all:nnN {\h+} {\ } #1
    \regex_replace_all:nnN {\ \n} {\n} #1
    \regex_replace_all:nnN {\n+} {\n} #1
}

\ExplSyntaxOff

\ExplSyntaxOn

\iftoggle{IMEthesis}
  {
    \renewcommand\author[2][masc]{
      \gdef\@author{#2}
      \gdef\@authorGender{#1}

      \bgroup
      \@IMEremoveLinebreaksEtc{\@author}
      \hypersetup{pdfauthor={\@author}}
      \egroup
    }

    \RenewDocumentCommand\title{mO{}}{
      \gdef\@title{#1}
      \gdef\@subtitle{#2}

      \ifdefvoid{\@subtitle}
        {\global\let\@fulltitle\@title}
        {\gdef\@fulltitle{\@title\c_colon_str\space\@subtitle}}

      \@IMEremoveLinebreaksEtc{\@fulltitle}

      \hypersetup{pdftitle={\@fulltitle}}

      \IfLanguagePatterns{brazilian}
        {
          \global\let\@titlept\@title
          \global\let\@subtitlept\@subtitle
          \global\let\@fulltitlept\@fulltitle
        }
        {}
      \IfLanguagePatterns{english}
        {
          \global\let\@titleen\@title
          \global\let\@subtitleen\@subtitle
          \global\let\@fulltitleen\@fulltitle
        }
        {}
    }

    \NewDocumentCommand\translatedtitle{mO{}}{
      \gdef\@translatedtitle{#1}
      \gdef\@translatedsubtitle{#2}

      \ifdefvoid{\@translatedsubtitle}
        {\global\let\@fulltranslatedtitle\@translatedtitle}
        {\gdef\@fulltranslatedtitle
            {\@translatedtitle\c_colon_str\space\@translatedsubtitle}%
        }

      \@IMEremoveLinebreaksEtc{\@fulltranslatedtitle}

      \IfLanguagePatterns{brazilian}
        {}
        {
          \XMPLangAlt{pt}{pdftitle={\@fulltranslatedtitle}}
          \global\let\@titlept\@translatedtitle
          \global\let\@subtitlept\@translatedsubtitle
          \global\let\@fulltitlept\@fulltranslatedtitle
        }
      \IfLanguagePatterns{english}
        {}
        {
          \XMPLangAlt{en}{pdftitle={\@fulltranslatedtitle}}
          \global\let\@titleen\@translatedtitle
          \global\let\@subtitleen\@translatedsubtitle
          \global\let\@fulltitleen\@fulltranslatedtitle
        }
    }
  }
  {}
\ExplSyntaxOff


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% IMPRIME A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
    \RenewDocumentCommand\maketitle{}{
      % Embora as páginas iniciais *pareçam* não ter numeração, a numeração
      % existe, só não é impressa. Os comandos \frontmatter, \mainmatter,
      % \pagenumbering etc. reiniciam a contagem de páginas quando os números
      % passam a ser impressos. Isso significa que há mais de uma página com
      % o número "1". O pacote hyperref não lida bem com essa situação, então
      % vamos desabilitar hyperlinks para números de páginas aqui.
      \hypersetup{pageanchor=false}
      \bgroup
      \onehalfspacing

      \@IMEcover
      \iftoggle{@tcc}{}{\@IMEtitlePage}
      \@IMEversoPage

      \egroup
      \if@openright\cleardoublepage\else\clearpage\fi
      \hypersetup{pageanchor=true}
    }
}{}

% Layout da capa
\NewDocumentCommand{\@IMEcover}{} {
  \cleardoublepage
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \iftoggle{@tcc}{\@institutionBlock}{}
      \@titleBlock
      \vspace*{\fill}
      \@detailsBlock
  \end{hyphenrules}
}

% Layout para a página de rosto (duas versões, de acordo
% com a Resolução CoPGr 6018 de 13/10/2011)
\NewDocumentCommand{\@IMEtitlePage}{} {
  \if@openright\cleardoublepage\else\clearpage\fi
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \@titleBlock
      \vspace*{2cm plus 2cm minus 1cm}
      \@versionInfoBlock
      \vspace*{3.5cm plus 3cm minus 3.5cm}
      \iftoggle{@finalversion}{\@committeeBlock}{}
      \vspace*{2cm plus 2cm minus 2cm}
  \end{hyphenrules}
}

\NewDocumentCommand{\@IMEversoPage}{}{
  \clearpage
  \thispagestyle{empty}
  \ifcsvoid{@catalogingData}
    {\vspace*{4cm}}
    {\vspace*{2cm}}

  \begin{list}{}{\rightmargin 3em \leftmargin 3em}
    \onehalfspacing\centering\footnotesize\itshape
    \item\@license
  \end{list}

  \ifcsvoid{@catalogingData} {} {\vspace{\fill}\@catalogingData}

  \vspace{1cm minus 1cm}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% POSIÇÃO DOS ELEMENTOS NA CAPA %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% O IME usa uma capa padrão de cartolina para todas as teses/dissertações.
% Essa capa tem uma janela recortada por onde se vê o título e o autor do
% trabalho. Ela fica centralizada na página, tem 100m de largura, 60mm de
% altura e começa 47mm abaixo do topo da página. Como o documento já tem
% margens definidas pelo usuário, precisamos calcular quanto precisamos
% acrescentar ou subtrair dessas margens para colocar o título e autor
% na posição exata (na verdade, com uma pequena folga: 49mm abaixo do topo
% da página, 96mm de largura e 56mm de altura).
%
% Para centralizar horizontalmente, poderíamos pensar em usar "\center",
% mas isso não funciona porque ele centraliza o texto em relação à coluna
% de texto, não à página. Assim, como as margens esquerda e direita do
% documento podem ser diferentes, a janela não ficaria na posição correta.
% O que faremos, então, é colocar essa janela em uma minipage e calcular
% a margem esquerda para que essa minipage fique centralizada.
%
% Além disso, outros elementos da capa também não podem ser centralizados
% com "\center", porque eles ficariam desalinhados em relação à janela
% com o título e autor. Vamos colocar esses outros elementos em uma
% minipage também, mas de tamanho diferente da anterior.
%
% Então, precisamos calcular três valores: a margem adicional em relação ao
% topo da página, a margem esquerda da janela com título e autor e a margem
% esquerda para os demais elementos centralizados da página.

\AtEndPreamble{
  % Calcula o valor das margens (após geometry ser carregada)

  % A distância entre o topo da página e o início do texto (fora o cabeçalho)
  % é dada por (1in + \voffset + \headsep + \topmargin + \headheight).
  % Queremos colocar a caixa com o título 49mm abaixo do topo, então:
  \dimgdef\@topTitleBlockMargin{49mm - (1in + \voffset + \headsep + \topmargin + \headheight)}

  % Quando \vspace é usado no início da página, ele não tem efeito; como
  % não é isso que queremos, vamos usar \vspace*. No entanto, \vspace*
  % é implementado inserindo uma \hrule de espessura zero e depois
  % acrescentando o espaço solicitado. O resultado não é exatamente
  % o esperado, pois \topskip, \parskip e \baselineskip interagem com
  % \vspace* de maneira um tanto complexa:
  % https://tex.stackexchange.com/a/247516
  %
  % Aqui, vamos compensar essa diferença. Note que, se a primeira linha
  % da página tivesse um tamanho de fonte especial, seria necessário
  % usar o valor de \baselineskip correspondente a essa fonte. Além
  % disso, definimos espaçamento simples porque o \vspace* mencionado
  % acima é executado com espaçamento simples.
  \bgroup
  \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip
  \dimgdef\@topTitleBlockMargin{\@topTitleBlockMargin - \baselineskip - \parskip}
  \egroup

  % Queremos colocar a caixa com o título centralizada na página. "\center"
  % centraliza em função da área de texto, não da página inteira, então
  % não podemos usá-lo, pois as margens esquerda e direita podem ser
  % diferentes. A distância entre a borda esquerda/interna do papel e o
  % início do texto é dada por (1in + \hoffset + \oddsidemargin), então:
  \dimgdef\@leftTitleBlockMargin{(\paperwidth - 96mm)/2 - (1in + \hoffset + \oddsidemargin)}
  \dimgdef\@coverLeftMargin{(\paperwidth - 160mm)/2 - (1in + \hoffset + \oddsidemargin)}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%% OS ELEMENTOS QUE COMPÕEM A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Com fontspec (ou seja, lualatex/xelatex), o comando \oldstylenums funciona
% com qualquer fonte que tenha suporte a números old-style. Já com pdflatex,
% o comando para escolher números old style depende da fonte em uso. Nesse
% caso, se não soubermos qual a fonte atual (ou seja, não é libertinus), vamos
% usar latin modern e torcer para o resultado não ser % muito discrepante do
% restante do texto.

% 499 = CDXCIX
\@ifpackageloaded{fontspec}
  {\providecommand{\@macCDXCIX}{mac~\oldstylenums{499}}}
  {
    \providecommand{\@macCDXCIX}{{\fontfamily{lmr}\selectfont mac~\oldstylenums{499}}}

    \@ifpackageloaded{libertinus}
      {\renewcommand{\@macCDXCIX}{{\LibertinusSerifOsF mac~499}}}
      {}
  }

\newcommand{\@coverText}{
  \bgroup
  \setstretch{.9}

  \iftoggle{@tcc}
    {\@coverTCCText}
    {\iftoggle{@qualificacao}{\@coverQualiText}{\@coverThesisText}}
  \par
  \egroup
}

\ExplSyntaxOn
\newcounter{@IMEtmpcnt}
\newcommand*{\@coverPeople} {%
  \begin{tabular}{rl}
    \iftoggle{@tcc}
      {}
      {
        \ifdefvoid{\@program}
          {}
          {\programname : & \@program \tabularnewline}
      }
    \ifdefvoid{\@advisor}
      {}
      {\advisorname : & \@advisor \tabularnewline}
    \setcounter{@IMEtmpcnt}{0}%
    \int_while_do:nNnn {\value{@IMEtmpcnt}} < {\value{numberOfCoadvisors}} {%
      \stepcounter{@IMEtmpcnt}%
      \coadvisorname{\Roman{@IMEtmpcnt}}: & \csuse{@coadvisor\Roman{@IMEtmpcnt}} \tabularnewline
    }%
  \end{tabular}
}

\ExplSyntaxOff

\newcommand{\@selfReference} {%
  \bgroup
  \IfLanguagePatterns{brazilian}
    {%
      \let\@currlangtitle\@titlept
      \let\@currlangsubtitle\@subtitlept
    }
    {%
      \let\@currlangtitle\@titleen
      \let\@currlangsubtitle\@subtitleen
    }%
  \@IMEremoveLinebreaksEtc{\@currlangtitle}%
  \@IMEremoveLinebreaksEtc{\@currlangsubtitle}%
  \@author.
  \textbf{\@currlangtitle\ifdefvoid{\@currlangsubtitle}{}{: \textit{\@currlangsubtitle}}}.
  \workname{} (\degreename).
  \@institution,
  São Paulo\DTMifsaveddate{@defensedate}{, \DTMfetchyear{@defensedate}}{}.%
  \egroup
}

% Só para TCC
\newcommand{\@institutionBlock}{

    % A posição do quadro de título é fixa em relação à página;
    % a posição deste quadro é definida em função da posição do
    % quadro de título. Assim, primeiro vamos encontrar onde
    % deve começar o quadro do título. Veja os comentários em
    % \@titleBlock para entender o mecanismo.
    \bgroup
    \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui

    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    \vspace*{\@topTitleBlockMargin}
    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    % Estamos alinhados com o quadro do título do trabalho,
    % mas não é isso que queremos: a parte inferior deste
    % quadro deve ficar 15mm acima do quadro de título e
    % este quadro tem 20mm de altura, então precisamos subir:
    \vspace{-20mm} % Espaço ocupado por este quadro
    \vspace{-15mm} % Espaço entre este quadro e o quadro de título

    \noindent\strut%
    \hspace*{\@coverLeftMargin}%
%    \fbox{%
      \begin{minipage}[t][20mm][s]{160mm}
        \vspace{0pt plus 20mm}

        \centering\large

        \textsc{\@institutionBlockText}

        \vspace{0pt plus 20mm}
      \end{minipage}
%    }% fbox
    \par

    % Agora precisamos voltar o "cursor" para o começo da página
    % para que o quadro de título seja inserido no lugar certo.
    % Para isso, vamos:
    %
    % 1. Chegar novamente ao início do quadro de título e
    %
    % 2. Retroceder o tamanho da margem superior

    % compensa o espaço inserido por \par logo acima
    \vspace{-\parskip}
    \egroup

    % A altura da minipage já compensou o \vspace{-20mm} acima;
    % ainda precisamos compensar o \vspace{-15mm}
    \vspace{15mm}

    % Agora estamos no início do quadro de título, então
    % podemos recuar exatamente o tamanho da margem superior.
    \vspace{-\@topTitleBlockMargin}
}

% O quadro com o título e o autor que deve ser visível
% através da janela na capa.
\NewDocumentCommand{\@titleBlock}{} {

    \bgroup
    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    % Este espaço coloca o topo da próxima linha
    % na posição que queremos:
    \vspace*{\@topTitleBlockMargin}

    % No entanto, a próxima linha contém apenas
    % uma minipage, e definir o topo de uma linha
    % desse tipo é complicado. Assim, vamos:
    %
    % 1. Acrescentar um \strut a essa linha;
    %
    % 2. mover o baseline dessa linha para o topo do \strut;
    %
    % 3. Alinhar o topo da minipage ao baseline da linha.
    %
    % Sobre alinhamento de minipages:
    % https://en.wikibooks.org/wiki/LaTeX/Boxes

    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    \noindent\strut
    \hspace*{\@leftTitleBlockMargin}%
%    \fbox{%
      \begin{minipage}[t][56mm][s]{96mm}
          \vspace*{2cm plus 1.5cm minus 1.8cm}

          \centering\large

          \textbf{\@title}

          \vspace{0.3cm plus 0.2cm minus 0.1cm}

          \ifdefvoid{\@subtitle}{}{\textbf{\textit{\@subtitle}}}

          \vspace{1cm plus 1cm minus 0.6cm}

          \@author

          \vspace*{2cm plus 1.5cm minus 1.8cm}
      \end{minipage}%
%    }% fbox
    \par
    \egroup
}

% As demais informações da capa
\NewDocumentCommand{\@detailsBlock}{} {

  \bgroup
  \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui
  \onehalfspacing
  \noindent
  \hspace*{\@coverLeftMargin}%
%  \fbox{%
    \begin{minipage}[t][130mm][s]{160mm}
      \begin{center}
        \Large

        \vspace*{0.3cm plus 0.5cm minus 0.3cm}

        \textsc{\@coverText}

        \vspace*{1.5cm plus 0.5cm minus 0.5cm}

        \large\@coverPeople

        \vspace*{2.5cm plus 1cm minus 1cm}

        \normalsize

        \bgroup
        \singlespacing
        \strut\ifdefvoid{\@financing}{}{\@financing}\par
        \egroup

        \vspace*{1cm plus 1cm minus 0.3cm}

        \strut\ifdefvoid{\@defenselocation}{}{\@defenselocation}

        \DTMifsaveddate{@defensedate}
          {
            \iftoggle{@tcc}
              {\DTMfetchyear{@defensedate}}
              {\DTMsetdatestyle{month-year}\DTMusedate{@defensedate}}\par
          }
          {}

      \end{center}
    \end{minipage}%
%  }% fbox
  \par
  \egroup
}

% As informações da banca que vão apenas na versão definitiva
% da página de rosto
\ExplSyntaxOn
\NewDocumentCommand{\@committeeBlock}{} {
    \seq_if_empty:NTF{\@committeeMembers}
      {}
      {
        \bgroup
        \onehalfspacing
        \begin{minipage}[t][][t]{\textwidth}
          \begin{quote}
            \normalsize\noindent\committeename :\par
            \begin{list}{}
            {
              \setlength{\leftmargin}{0pt}
              \setlength{\itemsep}{.1\baselineskip}
              \setlength{\topsep}{\baselineskip}
            }
              \item[] \seq_use:Nn \@committeeMembers {\item[]}
            \end{list}
          \end{quote}
        \end{minipage}
        \par
        \egroup
      }
}
\ExplSyntaxOff

% A informação sobre a versão provisória ou definitiva
\NewDocumentCommand{\@versionInfoBlock}{} {%
  % As diretrizes dizem que "A natureza do trabalho, o grau pretendido, o
  % nome da instituição a que é submetido e a área de concentração devem
  % ser alinhados a partir do meio da parte impressa da página para a
  % margem direita, tanto na folha de rosto como na folha de avaliação."
  %
  % Assim, queremos alinhar o texto à direita com uma grande margem
  % à esquerda. Uma solução simples é alinhar o texto à direita
  % e inserir uma minipage. Dentro dela, definimos o texto
  % também alinhado à direita.

  \bgroup
  \onehalfspacing
  \begin{FlushRight}
    %\fbox{
      % Margem direita + 80mm de largura significa que a minipage
      % começa mais ou menos no meio da página.
      \begin{minipage}[t][50mm][s]{80mm}
        \begin{FlushRight}
          \normalsize
          \iftoggle{@finalversion}{%
            \@finalFrontmatterText%
          } {%
            \@provisionalFrontmatterText%
          }%
        \end{FlushRight}
        \vspace*{0pt plus 50mm}
      \end{minipage}
      \par
    %} % fbox
  \end{FlushRight}
  \egroup
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ANEXOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEreport}{
  % A classe Book inclui o comando \appendix, que (obviamente) permite inserir
  % apêndices no documento. No entanto, não há suporte similar para anexos. Esta
  % package acrescenta alguns recursos adicionais para apêndices; vamos usá-la
  % para permitir colocar a palavra "Apêndice" no sumário e também para definir
  % o comando \annex.
  \RequirePackage{appendix}
  \noappendicestocpagenum

  % Altera a formatação da palavra "Apêndice" no sumário
  %
  % Não queremos a linha "Apêndice" como a última da página no sumário;
  % para isso:
  %
  % 1. Acrescentamos um pouco de espaço elástico logo antes dela
  %
  % 2. Colocamos uma sugestão de quebra de página
  %
  % 3. Usamos \@afterheading
  %
  % 1 e 2 incentivam (mas não forçam) LaTeX a realizar a quebra antes
  % dela e 3 força LaTeX a mantê-la na mesma página que a próxima linha.
  %
  % \addtocontents pode pregar peças se usamos \include; contornamos
  % com \immediate: https://tex.stackexchange.com/a/13926
  \renewcommand\addappheadtotoc{%
    \begingroup
      \let\origwrite\write
      \def\write{\immediate\origwrite}%
      \addtocontents{toc}{{\large\vspace{0pt plus 2\baselineskip minus 0pt}}}%
      \addtocontents{toc}{\protect\pagebreak[2]}%
      \addtocontents{toc}{\vspace{.8\baselineskip}}%
      \addtocontents{toc}{{\large\bfseries\hspace{-1.3em}\appendixtocname\par}}%
      \addtocontents{toc}{\protect\@afterheading}%
    \endgroup
  }

  \let\@IMErealAppendixname\appendixname
  \let\@IMErealAppendixtocname\appendixtocname
  \let\@IMErealAppendixpagename\appendixpagename
  \def\appendixname{\@IMErealAppendixname}
  \def\appendixtocname{\@IMErealAppendixtocname}
  \def\appendixpagename{\@IMErealAppendixpagename}

  \providecommand\annexname{Annex}
  \providecommand\annextocname{Annexes}
  \providecommand\annexpagename{Annexes}

  \addto\captionsbrazil{%
    \renewcommand\annexname{Anexo}%
    \renewcommand\annextocname{Anexos}%
    \renewcommand\annexpagename{Anexos}%
    \renewcommand\@IMErealAppendixname{Apêndice}%
    \renewcommand\@IMErealAppendixtocname{Apêndices}%
    \renewcommand\@IMErealAppendixpagename{Apêndices}%
  }

  \addto\captionsbrazilian{%
    \renewcommand\annexname{Anexo}%
    \renewcommand\annextocname{Anexos}%
    \renewcommand\annexpagename{Anexos}%
    \renewcommand\@IMErealAppendixname{Apêndice}%
    \renewcommand\@IMErealAppendixtocname{Apêndices}%
    \renewcommand\@IMErealAppendixpagename{Apêndices}%
  }

  \addto\captionsenglish{%
    \renewcommand\annexname{Annex}%
    \renewcommand\annextocname{Annexes}%
    \renewcommand\annexpagename{Annexes}%
    \renewcommand\@IMErealAppendixname{Appendix}%
    \renewcommand\@IMErealAppendixtocname{Appendixes}%
    \renewcommand\@IMErealAppendixpagename{Appendixes}%
  }

  \let\@IMEorigAppendix\appendix
  \renewcommand\appendix{%
      \def\appendixname{\@IMErealAppendixname}
      \def\appendixtocname{\@IMErealAppendixtocname}
      \def\appendixpagename{\@IMErealAppendixpagename}
      \def\Hy@appendixstring{appendix}%
      \@IMEorigAppendix
  }

  \newcommand\annex{%
      \def\Hy@appendixstring{annex}
      \def\appendixname{\annexname}
      \def\appendixtocname{\annextocname}
      \def\appendixpagename{\annexpagename}
      \@IMEorigAppendix
  }

}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ÍNDICE REMISSIVO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEreport}{
  % A criação do índice remissivo depende de um programa auxiliar, que pode ser
  % o "makeindex" (default) ou o xindy. xindy é mais poderoso e lida melhor com
  % línguas diferentes e caracteres acentuados, mas o programa não está mais
  % sendo mantido.
  %\RequirePackage[xindy]{imakeidx} % usando xindy
  \RequirePackage{imakeidx} % usando makeindex

  % Por padrão, o cabeçalho das páginas do índice é feito em maiúsculas;
  % vamos mudar isso e deixar fancyhdr definir a formatação
  \indexsetup{othercode={\chaptermark{\indexname}},}

  \makeindex[
    noautomatic,
    intoc,
    % Estas opções são usadas por xindy
    % "-C utf8" ou "-M lang/latin/utf8.xdy" são truques para contornar este
    % bug, que existe em outras distribuições tambem:
    % https://bugs.launchpad.net/ubuntu/+source/xindy/+bug/1735439
    % Se "-C utf8" não funcionar, tente "-M lang/latin/utf8.xdy"
    %options=-C utf8 -M hyperxindy.xdy,
    %options=-M lang/latin/utf8.xdy -M hyperxindy.xdy,
    % Estas opções são usadas por makeindex
    options=-s mkidxhead.ist -l -c,
  ]
}{} % \iftoggle{IMEreport}

% filecontents não funciona dentro de iftoggle;
% vamos usar newif para contornar isso.
\newif\ifIMEindex
\IMEindexfalse
\iftoggle{IMEreport}{\IMEindextrue}

\ifIMEindex

% Índices criados com xindy não funcionam em conjunto com hyperref; os criados
% com makeindex podem funcionar, mas apenas se hyperref for carregada após
% imakeidx. Para contornar esse problema, configuramos hyperref para *não*
% gerar hyperlinks no índice (mais abaixo) e configuramos xindy/makeindex
% para que eles gerem esses hyperlinks por conta própria (a configuração de
% makeindex foi copiada da documentação de hyperref).

% Cria o arquivo de configuração para xindy lidar corretamente com hyperlinks.
%\begin{filecontents*}{hyperxindy.xdy}
%(define-attributes ("emph"))
%(markup-locref :open "\hyperpage{" :close "}" :attr "default")
%(markup-locref :open "\textbf{\hyperpage{" :close "}}" :attr "textbf")
%(markup-locref :open "\textit{\hyperpage{" :close "}}" :attr "textit")
%(markup-locref :open "\emph{\hyperpage{" :close "}}" :attr "emph")
%\end{filecontents*}

% Cria o arquivo de configuração para makeindex lidar corretamente com
% hyperlinks e colocar um cabeçalho para cada letra do índice.
\begin{filecontents*}{mkidxhead.ist}
delim_0 ", \\hyperpage{"
delim_1 ", \\hyperpage{"
delim_2 ", \\hyperpage{"
delim_n "}, \\hyperpage{"
delim_t "}"
encap_prefix "}\\"
encap_infix "{\\hyperpage{"
encap_suffix "}"
headings_flag 1
heading_prefix "{\\bfseries "
heading_suffix "}\\nopagebreak\n"
\end{filecontents*}

\fi % \ifIMEindex

% Os comandos \TeX e \LaTeX são nativos do LaTeX; esta package acrescenta
% comandos para vários outros logos da família TeX. Você provavelmente não
% precisa desse recurso e, portanto, pode removê-la.
\RequirePackage{hologo}
\providecommand{\XeLaTeX}{\hologo{XeLaTeX}}
